name: Random KMS Verification

on:
  # Run every 10 minutes with 4/144 probability (~4 verifications per day at random times)
  # This creates a 10-minute attack window
  # Note: GitHub Actions enforces minimum ~5-10 minute intervals for scheduled workflows
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes

  # Manual trigger for testing
  workflow_dispatch:

permissions:
  contents: read

jobs:
  maybe-trigger-verification:
    name: Random Verification Trigger
    runs-on: ubuntu-latest

    steps:
      - name: Roll the dice (4/144 = 1/36 probability)
        id: dice
        run: |
          # Generate random number 0-35 (36 possibilities)
          # If 0, trigger verification (1/36 = 4/144 chance per 10 minutes)
          # Expected: ~4 verifications per day at completely random times
          ROLL=0  # TESTING: Force trigger to verify PAT works
          # ROLL=$((RANDOM % 36))  # TODO: Uncomment after testing
          echo "Dice roll: $ROLL (need 0 to trigger) [TESTING MODE - ALWAYS TRIGGERS]"

          if [ $ROLL -eq 0 ]; then
            echo "üé≤ Lucky roll! Triggering verification..."
            echo "trigger=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  Not this time. Next check in 10 minutes."
            echo "trigger=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger verification workflow
        if: steps.dice.outputs.trigger == 'true'
        run: |
          # Note: GITHUB_TOKEN cannot trigger repository_dispatch events
          # We use a PAT with public_repo scope stored in VERIFICATION_TRIGGER_TOKEN
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.VERIFICATION_TRIGGER_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"verify-deployment"}'

          echo "‚úÖ Verification workflow triggered on verifier branch"
          echo "Check: https://github.com/${{ github.repository }}/actions"

      - name: Log skip
        if: steps.dice.outputs.trigger == 'false'
        run: |
          echo "‚ÑπÔ∏è  Skipped this time (1/36 probability per check)"
          echo "Next check in 10 minutes"
