name: Verify KMS Deployment

on:
  # Triggered by repository_dispatch from main branch
  repository_dispatch:
    types: [verify-deployment]

  # Manual trigger for testing
  workflow_dispatch:

  # Can also run on push to verifier branch for testing
  push:
    branches:
      - verifier

permissions:
  contents: write  # For committing to attestation branch

jobs:
  verify:
    name: Verify kms.ats.run
    runs-on: ubuntu-latest

    steps:
      - name: Checkout verifier branch
        uses: actions/checkout@v4
        with:
          ref: verifier

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run verification and save results
        id: verify
        run: |
          set +e  # Don't fail workflow on verification failure

          # Run verification and capture output
          pnpm exec tsx verifier/verify-deployment.ts > verification-output.log 2>&1
          VERIFICATION_RESULT=$?

          # Show output
          cat verification-output.log

          echo "exit_code=$VERIFICATION_RESULT" >> $GITHUB_OUTPUT
          if [ $VERIFICATION_RESULT -eq 0 ]; then
            echo "verification_passed=true" >> $GITHUB_OUTPUT
          else
            echo "verification_passed=false" >> $GITHUB_OUTPUT
          fi
        env:
          KMS_URL: https://kms.ats.run

      - name: Get worker hash from manifest
        id: manifest
        run: |
          HASH=$(curl -s https://kms.ats.run/.well-known/kms-manifest.json | jq -r '.current.sha256')
          echo "worker_hash=$HASH" >> $GITHUB_OUTPUT

          VERSION=$(curl -s https://kms.ats.run/.well-known/kms-manifest.json | jq -r '.current.version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get current timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Generate badge and report
        run: |
          # Generate badge
          pnpm exec tsx verifier/generate-badge.ts

          # TODO: Generate full report (for Phase 2.2)
          # For now, create a simple report
          mkdir -p attestation-output

          cat > attestation-output/README.md << 'EOF'
          # üîê KMS Verification Report

          **Status:** ${{ steps.verify.outputs.verification_passed == 'true' && '‚úÖ VERIFIED' || '‚ùå FAILED' }}
          **Timestamp:** ${{ steps.timestamp.outputs.timestamp }}
          **Worker Hash:** `${{ steps.manifest.outputs.worker_hash }}`
          **Version:** ${{ steps.manifest.outputs.version }}
          **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---

          ## Verification Results

          See [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed results.

          ---

          ## About This Report

          This report is automatically generated by the [KMS Verifier](https://github.com/${{ github.repository }}/tree/verifier).

          The verifier runs approximately **4 times per day** at random times to check that the deployed KMS enclave matches the published manifest and security specifications.

          ### What Gets Verified:
          1. Manifest integrity and structure
          2. Worker hash matches deployed version
          3. SRI (Subresource Integrity) hashes for all resources
          4. Security headers (CSP, Permissions-Policy, etc.)
          5. Current version is in allowed list
          6. [Future] Rekor transparency log attestation

          ### Trust Model:
          - **Verifier Code:** Frozen and auditable at specific commit
          - **This Report:** Auto-generated, constantly updated
          - **Badge:** Links to this report for transparency

          ---

          *Last updated: ${{ steps.timestamp.outputs.timestamp }}*
          *Verifier: [github.com/${{ github.repository }}/tree/verifier](https://github.com/${{ github.repository }}/tree/verifier)*
          EOF

          # Copy badge to attestation output
          cp verifier/verification-badge.svg attestation-output/
          cp verifier/verification-badge.json attestation-output/
        env:
          VERIFICATION_PASSED: ${{ steps.verify.outputs.verification_passed }}
          VERIFICATION_TIMESTAMP: ${{ steps.timestamp.outputs.timestamp }}
          WORKER_HASH: ${{ steps.manifest.outputs.worker_hash }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          OUTPUT_DIR: ./verifier

      - name: Checkout attestation branch
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Copy attestation outputs to temp location
          mkdir -p /tmp/attestation
          cp attestation-output/* /tmp/attestation/

          # Try to checkout attestation branch, create if doesn't exist
          git fetch origin attestation || true
          git checkout attestation || git checkout --orphan attestation

          # Clear everything except .git
          git rm -rf . || true
          git clean -fdx  # Remove untracked files too

          # Copy attestation outputs from temp
          cp /tmp/attestation/* .

          # Add only report files
          git add README.md verification-badge.svg verification-badge.json
          git commit -m "chore: Update verification report

          Verification run: ${{ github.run_id }}
          Status: ${{ steps.verify.outputs.verification_passed == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }}
          Worker hash: ${{ steps.manifest.outputs.worker_hash }}
          Timestamp: ${{ steps.timestamp.outputs.timestamp }}

          ü§ñ Generated by verification workflow" || echo "No changes to commit"

          # Force push (overwrites any existing messy commits)
          git push --force origin attestation || git push --force --set-upstream origin attestation

      - name: Create status comment
        if: always()
        run: |
          echo "## üîê KMS Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.verify.outputs.verification_passed == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** ${{ steps.timestamp.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "**Worker Hash:** \`${{ steps.manifest.outputs.worker_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Report:** https://github.com/${{ github.repository }}/tree/attestation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See full logs above for detailed verification results." >> $GITHUB_STEP_SUMMARY

      - name: Fail workflow if verification failed
        if: steps.verify.outputs.exit_code != '0'
        run: |
          echo "‚ùå Verification failed!"
          exit 1
