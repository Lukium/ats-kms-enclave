# Security Headers for KMS Enclave (kms.ats.run)
#
# These headers are PRODUCTION-READY and will remain in Phase 2.
# They enforce strict security policies for the KMS enclave.
#
# References:
# - CSP: https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP
# - COOP/COEP: https://web.dev/coop-coep/
# - Permissions Policy: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Permissions-Policy

# KMS Enclave HTML (iframe entry point)
# Applies to both root (index.html) and /kms.html
/*
  # Content Security Policy - Strict isolation
  # - default-src 'none': Block all by default
  # - script-src 'self': Only load scripts from same origin
  # - style-src 'self': Only load styles from same origin
  # - img-src 'self' https://raw.githubusercontent.com/Lukium/ats-kms-enclave/attestation/verification-badge.svg: Only load images from same origin and specific verification badge
  # - connect-src 'self': Only fetch from same origin (for self-verification)
  # - worker-src 'self': Allow dedicated worker from same origin
  # - frame-ancestors: Allow alpha (dev), beta (staging), production, phase2-demo, and localhost
  Content-Security-Policy: default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' https://raw.githubusercontent.com/Lukium/ats-kms-enclave/attestation/verification-badge.svg; connect-src 'self'; worker-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors https://alpha.allthe.services https://beta.allthe.services https://allthe.services https://phase2-demo.allthe.services http://localhost:5173; form-action 'none'

  # Permissions Policy - Explicitly deny all unnecessary browser features
  # The KMS enclave only needs: JavaScript execution, IndexedDB, WebCrypto, postMessage, and WebAuthn
  # All other browser APIs are explicitly denied for defense in depth
  Permissions-Policy: accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), bluetooth=(), camera=(), display-capture=(), document-domain=(), encrypted-media=(), fullscreen=(), geolocation=(), gyroscope=(), hid=(), idle-detection=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), screen-wake-lock=(), serial=(), speaker-selection=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()

  # Cross-Origin Policies - DISABLED (cross-origin isolation not achievable with iframe embedding)
  # Cross-Origin-Opener-Policy: same-origin-allow-popups
  # Cross-Origin-Embedder-Policy: require-corp

  # Standard security headers
  X-Content-Type-Options: nosniff
  Referrer-Policy: no-referrer

  # Cache for 5 minutes (will be content-addressed in Phase 2)
  Cache-Control: public, max-age=300

# KMS Manifest - Version and hash information
/.well-known/kms-manifest.json
  Content-Type: application/json; charset=utf-8

  # CORS - Allow any origin to read manifest (for verification)
  Access-Control-Allow-Origin: *

  # Cache for 1 minute, must revalidate
  Cache-Control: public, max-age=60, must-revalidate

  # Standard security headers
  X-Content-Type-Options: nosniff

# Sigstore Transparency Log Attestations
/sigstore/*
  Content-Type: application/octet-stream

  # CORS - Allow any origin to verify attestations
  Access-Control-Allow-Origin: *

  # Cache forever (content-addressed, immutable)
  Cache-Control: public, max-age=31536000, immutable

  # Standard security headers
  X-Content-Type-Options: nosniff

# Content-addressed JavaScript modules (Phase 2)
# Pattern: /kms-worker.{hash}.js or /kms-{hash}.mjs
/*.js
  Content-Type: application/javascript; charset=utf-8

  # Same-origin only (no COEP, so no need for cross-origin)
  Cross-Origin-Resource-Policy: same-origin

  # Cache forever (content-addressed filename = immutable)
  Cache-Control: public, max-age=31536000, immutable

  # Standard security headers
  X-Content-Type-Options: nosniff

/*.mjs
  Content-Type: application/javascript; charset=utf-8

  # Same-origin only (no COEP, so no need for cross-origin)
  Cross-Origin-Resource-Policy: same-origin

  # Cache forever (content-addressed filename = immutable)
  Cache-Control: public, max-age=31536000, immutable

  # Standard security headers
  X-Content-Type-Options: nosniff

# Static CSS files
/*.css
  Content-Type: text/css; charset=utf-8

  # Same-origin only (no COEP, so no need for cross-origin)
  Cross-Origin-Resource-Policy: same-origin

  # Cache for 5 minutes (can be updated without content addressing)
  Cache-Control: public, max-age=300

  # Standard security headers
  X-Content-Type-Options: nosniff

# Static image files
/*.png
  Content-Type: image/png

  # Same-origin only (no COEP, so no need for cross-origin)
  Cross-Origin-Resource-Policy: same-origin

  # Cache for 1 hour
  Cache-Control: public, max-age=3600

  # Standard security headers
  X-Content-Type-Options: nosniff
