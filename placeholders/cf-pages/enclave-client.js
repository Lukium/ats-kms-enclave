var Gt=Object.defineProperty;var O=(s,e)=>()=>(s&&(e=s(s=0)),e);var Jt=(s,e)=>{for(var t in e)Gt(s,t,{get:e[t],enumerable:!0})};function L(s){if(s instanceof Error)return s.message;if(typeof s=="string")return s;if(typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string")return s.message;try{return String(s)}catch{return"Unknown error"}}function ve(s,e){return`${s}: ${L(e)}`}var Ke=O(()=>{"use strict"});function h(s){let e=new Uint8Array(s),t=Array.from(e,n=>String.fromCharCode(n)).join("");return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function A(s){let e=s.replace(/-/g,"+").replace(/_/g,"/"),t=e.length%4;t&&(e+="=".repeat(4-t));let r=atob(e),n=new Uint8Array(r.length);for(let a=0;a<r.length;a++)n[a]=r.charCodeAt(a);return n.buffer}function z(s){if(s.length!==65||s[0]!==4)throw new Error("Invalid uncompressed P-256 public key");let e=h(s.slice(1,33).buffer),t=h(s.slice(33).buffer);return{kty:"EC",crv:"P-256",x:e,y:t}}async function Q(s){let e={crv:s.crv,kty:s.kty,x:s.x,y:s.y},t=JSON.stringify(e),r=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(t));return h(r)}function Fe(s){return"{"+Object.keys(s).sort().map(r=>[r,s[r]]).map(([r,n])=>`"${String(r)}":${JSON.stringify(n)}`).join(",")+"}"}function le(s){let e={kmsVersion:s.kmsVersion,method:s.method,algVersion:s.algVersion,purpose:s.purpose};s.credentialId&&(e.credentialId=h(s.credentialId));let t=Fe(e);return new TextEncoder().encode(t).buffer}function ce(s){let e={kmsVersion:s.kmsVersion,kid:s.kid,alg:s.alg,purpose:s.purpose,createdAt:s.createdAt,keyType:s.keyType},t=Fe(e);return new TextEncoder().encode(t).buffer}async function Pe(s){let e=await crypto.subtle.exportKey("raw",s),t=await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),r=new TextEncoder().encode("ATS/KMS/KCV/v2");return await crypto.subtle.sign("HMAC",t,r)}function He(s,e){return zt(s,e)}function zt(s,e){let t=new Uint8Array(s),r=new Uint8Array(e);if(t.length!==r.length)return!1;let n=0;for(let a=0;a<t.length;a++)n|=t[a]^r[a];return n===0}async function re(s){return await crypto.subtle.digest("SHA-256",new TextEncoder().encode(s))}async function je(s={min:150,max:300,mid:220}){let e=await crypto.subtle.importKey("raw",new TextEncoder().encode("calibration"),"PBKDF2",!1,["deriveBits"]),t=crypto.getRandomValues(new Uint8Array(16)),r=1e5,n=performance.now();await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:t,iterations:r},e,256);let o=performance.now()-n,d=Math.round(r*s.mid/o);return d=Math.min(Math.max(d,5e4),2e6),{iterations:d,measuredMs:o}}var Y=O(()=>{"use strict"});async function pe(){return new Promise((s,e)=>{let t=indexedDB.open(Qt,Yt);t.onerror=()=>{e(new Error("Failed to open IndexedDB"))},t.onsuccess=()=>{$=t.result,s()},t.onupgradeneeded=r=>{let n=r.target.result;if(n.objectStoreNames.contains("config")||n.createObjectStore("config",{keyPath:"method"}),!n.objectStoreNames.contains("keys")){let a=n.createObjectStore("keys",{keyPath:"kid"});a.createIndex("by-purpose","purpose",{unique:!1}),a.createIndex("by-createdAt","createdAt",{unique:!1})}if(!n.objectStoreNames.contains("leases")){let a=n.createObjectStore("leases",{keyPath:"leaseId"});a.createIndex("by-userId","userId",{unique:!1}),a.createIndex("by-exp","exp",{unique:!1})}if(!n.objectStoreNames.contains("audit")){let a=n.createObjectStore("audit",{autoIncrement:!0});a.createIndex("by-seqNum","seqNum",{unique:!0}),a.createIndex("by-timestamp","timestamp",{unique:!1}),a.createIndex("by-op","op",{unique:!1}),a.createIndex("by-kid","kid",{unique:!1})}n.objectStoreNames.contains("meta")||n.createObjectStore("meta",{keyPath:"key"})}})}async function X(){if($||await pe(),!$)throw new Error("Database not initialized");return $}function $e(){$&&($.close(),$=null)}async function ye(s,e){let t=await X();return new Promise((r,n)=>{let d=t.transaction(s,"readonly").objectStore(s).get(e);d.onsuccess=()=>{r(d.result)},d.onerror=()=>{n(new Error(`Failed to get from ${s}`))}})}async function Z(s,e){let t=await X();return new Promise((r,n)=>{let d=t.transaction(s,"readwrite").objectStore(s).put(e);d.onsuccess=()=>{r()},d.onerror=()=>{n(new Error(`Failed to put to ${s}`))}})}async function Se(s,e){let t=await X();return new Promise((r,n)=>{let d=t.transaction(s,"readwrite").objectStore(s).delete(e);d.onsuccess=()=>{r()},d.onerror=()=>{n(new Error(`Failed to delete from ${s}`))}})}async function Xt(s){let e=await X();return new Promise((t,r)=>{let o=e.transaction(s,"readonly").objectStore(s).getAll();o.onsuccess=()=>{t(o.result)},o.onerror=()=>{r(new Error(`Failed to getAll from ${s}`))}})}async function B(s,e,t,r=s.algorithm,n=s.usages,a={alg:"unknown",purpose:"unknown"}){let o=crypto.getRandomValues(new Uint8Array(12)),d=Date.now(),i=ce({kmsVersion:2,kid:t,alg:a.alg,purpose:a.purpose,createdAt:d,keyType:Array.isArray(n)?n.join(","):String(n)}),u=s.type==="private"?"pkcs8":"raw",l=await crypto.subtle.exportKey(u,s),c=await crypto.subtle.encrypt({name:"AES-GCM",iv:o,additionalData:i},e,l),p={kid:t,kmsVersion:2,wrappedKey:c,iv:o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),aad:i,...a.publicKeyRaw!==void 0&&{publicKeyRaw:a.publicKeyRaw},alg:a.alg,purpose:a.purpose,createdAt:d};await Z("keys",p)}async function Ne(s,e,t,r=[]){let n=await ye("keys",s);if(!n)throw new Error(`No wrapped key with id: ${s}`);let a=new Uint8Array(n.iv),o=n.aad,d=await crypto.subtle.decrypt({name:"AES-GCM",iv:a,additionalData:o},e,n.wrappedKey),i=typeof t=="string"?t:t.name,l=i==="ECDSA"||i==="ECDH"||i==="Ed25519"||i.startsWith("RSA")?"pkcs8":"raw";return await crypto.subtle.importKey(l,d,t,!1,r)}async function W(s){return await ye("keys",s)??null}async function U(){return Xt("keys")}async function Ge(s){await Se("keys",s)}async function x(s){let e=await ye("meta",s);return e?e.value:null}async function T(s,e){await Z("meta",{key:s,value:e})}async function Je(s){await Se("meta",s)}async function _e(s){await Z("audit",s)}async function ee(){let s=await X();return new Promise((e,t)=>{let o=s.transaction("audit","readonly").objectStore("audit").index("by-seqNum").getAll();o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(new Error("Failed to get audit entries"))}})}async function ze(){let s=await ee();return s.length>0?s[s.length-1]:null}async function Ae(s){await Z("leases",s)}async function ne(s){return await ye("leases",s)??null}async function Ee(s){let e=await X();return new Promise((t,r)=>{let d=e.transaction("leases","readonly").objectStore("leases").index("by-userId").getAll(s);d.onsuccess=()=>{t(d.result)},d.onerror=()=>{r(new Error("Failed to get user leases"))}})}async function ae(s){await Se("leases",s)}async function Qe(s){let t=(await U()).filter(a=>a.purpose==="vapid");if(t.length===0)throw new Error("No VAPID key found. Generate a VAPID key first.");if(t.length>1)throw new Error("Multiple VAPID keys found. Cannot determine which to update.");let r=t[0];if(!r)throw new Error("No VAPID key found after filtering");let n={...r,subscription:s};await Z("keys",n)}async function Ye(){let e=(await U()).filter(a=>a.purpose==="vapid");if(e.length===0)throw new Error("No VAPID key found");if(e.length>1)throw new Error("Multiple VAPID keys found. Cannot determine which to update.");let t=e[0];if(!t)throw new Error("No VAPID key found after filtering");let{subscription:r,...n}=t;await Z("keys",n)}async function Ce(){let e=(await U()).filter(r=>r.purpose==="vapid");if(e.length===0)throw new Error("No VAPID key found");if(e.length>1)throw new Error("Multiple VAPID keys found. Cannot determine which to read.");let t=e[0];if(!t)throw new Error("No VAPID key found after filtering");return t.subscription??null}var Qt,Yt,$,fe=O(()=>{"use strict";Y();Qt="kms-v2",Yt=1,$=null});function xe(){let s=new Uint8Array(32);return crypto.getRandomValues(s),s}async function he(s,e,t){let r=t??xe(),{iterations:n}=await je(),a=crypto.getRandomValues(new Uint8Array(16)),o=await crypto.subtle.importKey("raw",new TextEncoder().encode(e),"PBKDF2",!1,["deriveKey"]),d=await crypto.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:a,iterations:n},o,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),i=await Pe(d),u=crypto.getRandomValues(new Uint8Array(12)),l=le({kmsVersion:2,method:"passphrase",algVersion:1,purpose:"master-secret"}),c=await crypto.subtle.encrypt({name:"AES-GCM",iv:u,additionalData:l},d,r),p={kmsVersion:2,algVersion:1,method:"passphrase",kdf:{algorithm:"PBKDF2-HMAC-SHA256",iterations:n,salt:a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength),lastCalibratedAt:Date.now(),platformHash:""},kcv:i,encryptedMS:c,msIV:u.buffer.slice(u.byteOffset,u.byteOffset+u.byteLength),msAAD:l,msVersion:1,createdAt:Date.now(),updatedAt:Date.now()};return await T(we(s),p),{success:!0,ms:r}}async function ke(s,e,t,r,n="",a,o){let d=r??xe(),i=a??crypto.getRandomValues(new Uint8Array(32)),u=o??await re("ATS/KMS/KEK-wrap/salt/v2"),l=new TextEncoder().encode("ATS/KMS/KEK-wrap/v2"),c=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveKey"]),p=u instanceof Uint8Array?u.buffer:u,y=await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:p,info:l},c,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),f=crypto.getRandomValues(new Uint8Array(12)),w=le({kmsVersion:2,method:"passkey-prf",algVersion:1,credentialId:e,purpose:"master-secret"}),g=await crypto.subtle.encrypt({name:"AES-GCM",iv:f,additionalData:w},y,d),m=Date.now(),k=i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength),P;u instanceof Uint8Array?P=u.buffer.slice(u.byteOffset,u.byteOffset+u.byteLength):P=u;let S={kmsVersion:2,algVersion:1,method:"passkey-prf",credentialId:e,rpId:n,kdf:{algorithm:"HKDF-SHA256",appSalt:k,hkdfSalt:P,info:"ATS/KMS/KEK-wrap/v2"},encryptedMS:g,msIV:f.buffer.slice(f.byteOffset,f.byteOffset+f.byteLength),msAAD:w,msVersion:1,createdAt:m,updatedAt:m};return await T(ge(s),S),{success:!0,ms:d}}async function be(s,e,t,r=""){let n=t??xe(),a=crypto.getRandomValues(new Uint8Array(32)),o=await re("ATS/KMS/KEK-gate/salt/v2"),d=new TextEncoder().encode("ATS/KMS/KEK-gate/v2"),i=await crypto.subtle.importKey("raw",a,"HKDF",!1,["deriveKey"]),u=await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:o,info:d},i,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),l=crypto.getRandomValues(new Uint8Array(12)),c=le({kmsVersion:2,method:"passkey-gate",algVersion:1,credentialId:e,purpose:"master-secret"}),p=await crypto.subtle.encrypt({name:"AES-GCM",iv:l,additionalData:c},u,n),y=Date.now(),f={kmsVersion:2,algVersion:1,method:"passkey-gate",credentialId:e,rpId:r,pepperWrapped:a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength),encryptedMS:p,msIV:l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength),msAAD:c,msVersion:1,createdAt:y,updatedAt:y};return await T(me(s),f),{success:!0,ms:n}}async function Zt(s,e){let t=await x(we(s));if(!t)return{success:!1,error:"Passphrase not set up"};let r=await crypto.subtle.importKey("raw",new TextEncoder().encode(e),"PBKDF2",!1,["deriveKey"]),n=await crypto.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:t.kdf.salt,iterations:t.kdf.iterations},r,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),a=await Pe(n);if(!He(a,t.kcv))return{success:!1,error:"Invalid passphrase"};try{let o=await crypto.subtle.decrypt({name:"AES-GCM",iv:t.msIV,additionalData:t.msAAD},n,t.encryptedMS);return{success:!0,ms:new Uint8Array(o)}}catch{return{success:!1,error:"Decryption failed"}}}async function es(s,e){let t=await x(ge(s));if(!t)return{success:!1,error:"Passkey not set up"};let r=t.kdf.hkdfSalt,n=new TextEncoder().encode(t.kdf.info),a=await crypto.subtle.importKey("raw",e,"HKDF",!1,["deriveKey"]),o=await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:r,info:n},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);try{let d=await crypto.subtle.decrypt({name:"AES-GCM",iv:t.msIV,additionalData:t.msAAD},o,t.encryptedMS);return{success:!0,ms:new Uint8Array(d)}}catch{return{success:!1,error:"Decryption failed"}}}async function ts(s){let e=await x(me(s));if(!e)return{success:!1,error:"Passkey gate not set up"};let t=new Uint8Array(e.pepperWrapped),r=await re("ATS/KMS/KEK-gate/salt/v2"),n=new TextEncoder().encode("ATS/KMS/KEK-gate/v2"),a=await crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveKey"]),o=await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:r,info:n},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);try{let d=await crypto.subtle.decrypt({name:"AES-GCM",iv:e.msIV,additionalData:e.msAAD},o,e.encryptedMS);return{success:!0,ms:new Uint8Array(d)}}catch{return{success:!1,error:"Decryption failed"}}}async function Re(s){let e=await x(we(s)),t=await x(ge(s)),r=await x(me(s));return!!(e||t||r)}async function Me(s){return!!await x(we(s))}async function De(s){let e=await x(ge(s)),t=await x(me(s));return!!(e||t)}async function ie(s){let e=await re("ATS/KMS/MKEK/salt/v2"),t=new TextEncoder().encode("ATS/KMS/MKEK/v2"),r=await crypto.subtle.importKey("raw",s,"HKDF",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:e,info:t},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt","wrapKey","unwrapKey"])}async function V(s,e){let t=Date.now(),r=null;try{let n;switch(s.method){case"passphrase":n=await Zt(s.userId,s.passphrase);break;case"passkey-prf":n=await es(s.userId,s.prfOutput);break;case"passkey-gate":n=await ts(s.userId);break;default:throw new Error("Unknown credential method")}if(!n.success)throw new Error(n.error??"Unlock failed");r=n.ms;let a=await ie(r),o=await e(a,r),d=Date.now();return{result:o,unlockTime:t,lockTime:d,duration:d-t}}finally{r&&r.fill(0)}}var we,ge,me,Xe=O(()=>{"use strict";Y();fe();we=s=>`enrollment:passphrase:v2:${s}`,ge=s=>`enrollment:passkey-prf:v2:${s}`,me=s=>`enrollment:passkey-gate:v2:${s}`});async function Ze(){}async function Ie(){let s=await x("LRK");return s||(s=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["wrapKey","unwrapKey","encrypt","decrypt"]),await T("LRK",s)),s}async function oe(s){let e=await crypto.subtle.digest("SHA-256",s);return h(e)}async function q(s){let e=await W("audit-user");if(e&&e.publicKeyRaw){let a=await crypto.subtle.unwrapKey("pkcs8",e.wrappedKey,s,{name:"AES-GCM",iv:e.iv,additionalData:e.aad},{name:"Ed25519"},!1,["sign"]),o=await crypto.subtle.importKey("raw",e.publicKeyRaw,{name:"Ed25519"},!1,["verify"]),d=await oe(e.publicKeyRaw);R={type:"UAK",keyPair:{privateKey:a,publicKey:o},keyId:d};return}let t=await crypto.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),r=await crypto.subtle.exportKey("raw",t.publicKey);await B(t.privateKey,s,"audit-user",{name:"Ed25519"},["sign"],{alg:"EdDSA",purpose:"audit",publicKeyRaw:r});let n=await oe(r);R={type:"UAK",keyPair:t,keyId:n}}async function et(s,e){if(!R||R.type!=="UAK")throw new Error("UAK must be active to generate LAK - call ensureAuditKey first");let t=Date.now(),r=await crypto.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),n=await crypto.subtle.exportKey("raw",r.publicKey),a=h(n),o={type:"audit-delegation",version:1,signerKind:"LAK",leaseId:s,delegatePub:a,scope:["vapid:issue","lease:expire"],notBefore:t,notAfter:e,codeHash:"TODO",manifestHash:"TODO",kmsVersion:"v2.0.0"},d=JSON.stringify(o,Object.keys(o).sort()),i=await crypto.subtle.sign("Ed25519",R.keyPair.privateKey,new TextEncoder().encode(d)),u={...o,sig:h(i)},l=await Ie(),c=ce({kmsVersion:2,kid:`lak-${s}`,alg:"EdDSA",purpose:"lak",createdAt:t,keyType:"lease-audit-key"}),p=crypto.getRandomValues(new Uint8Array(12)),y=await crypto.subtle.wrapKey("pkcs8",r.privateKey,l,{name:"AES-GCM",iv:p,additionalData:c});return await T(`lease-audit-key:${s}`,{leaseId:s,wrappedKey:y,iv:p,aad:c,publicKeyRaw:n,delegationCert:u,expiresAt:e,createdAt:t}),{lakKeyPair:r,delegationCert:u}}async function tt(s,e){let t=await x(`lease-audit-key:${s}`);if(!t)throw new Error(`LAK not found for lease: ${s}`);let r=await Ie(),n=await crypto.subtle.unwrapKey("pkcs8",t.wrappedKey,r,{name:"AES-GCM",iv:t.iv,additionalData:t.aad},{name:"Ed25519"},!1,["sign"]),a=await crypto.subtle.importKey("raw",t.publicKeyRaw,{name:"Ed25519"},!1,["verify"]),o=await oe(t.publicKeyRaw);R={type:"LAK",keyPair:{privateKey:n,publicKey:a},keyId:o,cert:e}}async function st(){let s=await W("audit-instance");if(s&&s.publicKeyRaw){let i=await Ie(),u=await crypto.subtle.unwrapKey("pkcs8",s.wrappedKey,i,{name:"AES-GCM",iv:s.iv,additionalData:s.aad},{name:"Ed25519"},!1,["sign"]),l=await crypto.subtle.importKey("raw",s.publicKeyRaw,{name:"Ed25519"},!1,["verify"]),c=await oe(s.publicKeyRaw);R={type:"KIAK",keyPair:{privateKey:u,publicKey:l},keyId:c};return}let e=await Ie(),t=await crypto.subtle.generateKey({name:"Ed25519"},!0,["sign"]),r=await crypto.subtle.exportKey("raw",t.publicKey);await B(t.privateKey,e,"audit-instance",{name:"Ed25519"},["sign"],{alg:"EdDSA",purpose:"audit-instance",publicKeyRaw:r});let n=await W("audit-instance");if(!n)throw new Error("Failed to retrieve wrapped KIAK after storage");let a=await crypto.subtle.unwrapKey("pkcs8",n.wrappedKey,e,{name:"AES-GCM",iv:n.iv,additionalData:n.aad},{name:"Ed25519"},!1,["sign"]),o=await crypto.subtle.importKey("raw",r,{name:"Ed25519"},!1,["verify"]),d=await oe(r);R={type:"KIAK",keyPair:{privateKey:a,publicKey:o},keyId:d}}async function M(s){let e,t,r=new Promise((n,a)=>{e=n,t=a});return Le=Le.then(async()=>{try{if(!R)throw new Error("No active audit signer - call ensureAuditKey, loadLAK, or ensureKIAK first");let n=Date.now(),a=await ze(),o=a?a.chainHash:"",i={kmsVersion:2,seqNum:a?a.seqNum+1:1,timestamp:n,op:s.op,kid:s.kid,requestId:s.requestId,userId:s.userId,origin:s.origin,leaseId:s.leaseId,unlockTime:s.unlockTime,lockTime:s.lockTime,duration:s.duration,details:s.details,previousHash:o,signer:R.type,signerId:R.keyId},u=JSON.stringify(i),l=new TextEncoder().encode(o+u),c=await crypto.subtle.digest("SHA-256",l),p=h(c),y=new TextEncoder().encode(p),f=await crypto.subtle.sign("Ed25519",R.keyPair.privateKey,y),w=h(f),g={kmsVersion:i.kmsVersion,seqNum:i.seqNum,timestamp:i.timestamp,op:i.op,kid:i.kid,requestId:i.requestId,userId:i.userId,...i.origin!==void 0&&{origin:i.origin},...i.leaseId!==void 0&&{leaseId:i.leaseId},...i.unlockTime!==void 0&&{unlockTime:i.unlockTime},...i.lockTime!==void 0&&{lockTime:i.lockTime},...i.duration!==void 0&&{duration:i.duration},...i.details!==void 0&&{details:i.details},previousHash:i.previousHash,chainHash:p,signer:i.signer,signerId:i.signerId,...R.cert!==void 0&&{cert:R.cert},sig:w};await _e(g),e(g)}catch(n){t(n)}}).catch(()=>{}),r}async function rt(){let s=await ee(),e=[],t=0;for(let r of s){let n={kmsVersion:r.kmsVersion,seqNum:r.seqNum,timestamp:r.timestamp,op:r.op,kid:r.kid,requestId:r.requestId,userId:r.userId,origin:r.origin,leaseId:r.leaseId,unlockTime:r.unlockTime,lockTime:r.lockTime,duration:r.duration,details:r.details,previousHash:r.previousHash,signer:r.signer,signerId:r.signerId},a=JSON.stringify(n),o=new TextEncoder().encode(r.previousHash+a),d=await crypto.subtle.digest("SHA-256",o);h(d)!==r.chainHash&&e.push(`Chain hash mismatch at seq ${r.seqNum}`),t+=1}return{valid:e.length===0,verified:t,errors:e}}async function nt(){let s=await W("audit-user");if(!s||!s.publicKeyRaw)throw new Error("UAK not initialized");return{publicKey:h(s.publicKeyRaw)}}function at(){R=null,Le=Promise.resolve()}var Le,R,it=O(()=>{"use strict";fe();Y();Le=Promise.resolve(),R=null});function C(s,e){if(typeof e!="object"||e===null)throw new E(s,"params","object",e);return e}function K(s,e,t){if(typeof t!="string")throw new E(s,e,"string",t);return t}function N(s,e,t){if(t!==void 0)return K(s,e,t)}function de(s,e,t){if(typeof t!="number")throw new E(s,e,"number",t);return t}function ss(s,e,t){if(typeof t!="boolean")throw new E(s,e,"boolean",t);return t}function ot(s,e,t){if(t!==void 0)return ss(s,e,t)}function Ue(s,e,t){if(t instanceof ArrayBuffer)return t;if(t instanceof Uint8Array){let r=new ArrayBuffer(t.byteLength);return new Uint8Array(r).set(t),r}throw new E(s,e,"ArrayBuffer or Uint8Array",t)}function Te(s,e,t){if(t!==void 0){if(t instanceof Uint8Array)return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);throw new E(s,e,"ArrayBuffer or Uint8Array",t)}}function G(s,e){if(typeof e!="object"||e===null)throw new E(s,"credentials","AuthCredentials object",e);let t=e;if(typeof t.method!="string")throw new E(s,"credentials.method","string",t.method);if(typeof t.userId!="string")throw new E(s,"credentials.userId","string",t.userId);switch(t.method){case"passphrase":if(typeof t.passphrase!="string")throw new E(s,"credentials.passphrase","string",t.passphrase);return{method:"passphrase",passphrase:t.passphrase,userId:t.userId};case"passkey-prf":if(!(t.prfOutput instanceof ArrayBuffer))throw new E(s,"credentials.prfOutput","ArrayBuffer",t.prfOutput);return{method:"passkey-prf",prfOutput:t.prfOutput,userId:t.userId};case"passkey-gate":return{method:"passkey-gate",userId:t.userId};default:throw new E(s,"credentials.method","passphrase | passkey-prf | passkey-gate",t.method)}}function rs(s,e){if(typeof e!="object"||e===null)throw new E(s,"payload","VAPIDPayload object",e);let t=e;return{aud:K(s,"payload.aud",t.aud),sub:K(s,"payload.sub",t.sub),exp:de(s,"payload.exp",t.exp),jti:K(s,"payload.jti",t.jti)}}function dt(s){let e=C("setupPassphrase",s),t=Te("setupPassphrase","existingMS",e.existingMS);return{userId:K("setupPassphrase","userId",e.userId),passphrase:K("setupPassphrase","passphrase",e.passphrase),...t!==void 0&&{existingMS:t}}}function ut(s){let e=C("setupPasskeyPRF",s);if(!e.credentialId)throw new Error("credentialId required");let t=N("setupPasskeyPRF","rpId",e.rpId),r=Te("setupPasskeyPRF","existingMS",e.existingMS);return{userId:K("setupPasskeyPRF","userId",e.userId),credentialId:Ue("setupPasskeyPRF","credentialId",e.credentialId),prfOutput:Ue("setupPasskeyPRF","prfOutput",e.prfOutput),...t!==void 0&&{rpId:t},...r!==void 0&&{existingMS:r}}}function lt(s){let e=C("setupWithPopup",s);return{userId:K("setupWithPopup","userId",e.userId)}}function ct(s){let e=C("fullSetup",s),r={userId:K("fullSetup","userId",e.userId)};if(e.autoExtend!==void 0){if(typeof e.autoExtend!="boolean")throw new E("fullSetup","autoExtend","boolean",typeof e.autoExtend);r.autoExtend=e.autoExtend}if(e.ttlHours!==void 0){let n=de("fullSetup","ttlHours",e.ttlHours);if(n<=0||n>720)throw new E("fullSetup","ttlHours","0 < ttlHours <= 720",n);r.ttlHours=n}return r}function pt(s){let e=C("setupPasskeyGate",s),t=N("setupPasskeyGate","rpId",e.rpId),r=Te("setupPasskeyGate","existingMS",e.existingMS);return{userId:K("setupPasskeyGate","userId",e.userId),credentialId:Ue("setupPasskeyGate","credentialId",e.credentialId),...t!==void 0&&{rpId:t},...r!==void 0&&{existingMS:r}}}function yt(s){let e=C("addEnrollment",s);return{userId:K("addEnrollment","userId",e.userId),credentials:G("addEnrollment",e.credentials)}}function ft(s){let e=C("addEnrollmentWithPopup",s);return{userId:K("addEnrollmentWithPopup","userId",e.userId)}}function wt(s){let e=C("generateVAPID",s);return{credentials:G("generateVAPID",e.credentials)}}function gt(s){let e=C("regenerateVAPID",s);return{credentials:G("regenerateVAPID",e.credentials)}}function mt(s){let e=C("signJWT",s);return{kid:K("signJWT","kid",e.kid),payload:rs("signJWT",e.payload),credentials:G("signJWT",e.credentials)}}function ht(s){let e=C("createLease",s),t={userId:K("createLease","userId",e.userId),ttlHours:de("createLease","ttlHours",e.ttlHours),credentials:G("createLease",e.credentials)},r=ot("createLease","autoExtend",e.autoExtend);return r!==void 0&&(t.autoExtend=r),t}function kt(s){let e=C("extendLeases",s);if(!Array.isArray(e.leaseIds))throw new Error(`RPC extendLeases: Invalid leaseIds - expected array, got ${typeof e.leaseIds}`);if(e.leaseIds.length===0)throw new Error("RPC extendLeases: leaseIds array cannot be empty");let r={leaseIds:e.leaseIds.map((a,o)=>{if(typeof a!="string"||a.length===0)throw new Error(`RPC extendLeases: Invalid leaseId at index ${o} - expected non-empty string`);return a}),userId:K("extendLeases","userId",e.userId)},n=ot("extendLeases","requestAuth",e.requestAuth);return n!==void 0&&(r.requestAuth=n),e.credentials!==void 0&&(r.credentials=G("extendLeases",e.credentials)),r}function bt(s){let e=C("issueVAPIDJWT",s),t=N("issueVAPIDJWT","kid",e.kid),r=N("issueVAPIDJWT","jti",e.jti),n=e.exp!==void 0?de("issueVAPIDJWT","exp",e.exp):void 0;return{leaseId:K("issueVAPIDJWT","leaseId",e.leaseId),...t!==void 0&&{kid:t},...r!==void 0&&{jti:r},...n!==void 0&&{exp:n}}}function It(s){let e=C("issueVAPIDJWTs",s),t=N("issueVAPIDJWTs","kid",e.kid);return{leaseId:K("issueVAPIDJWTs","leaseId",e.leaseId),count:de("issueVAPIDJWTs","count",e.count),...t!==void 0&&{kid:t}}}function vt(s){if(s==null)return{};let e=C("isSetup",s),t=N("isSetup","userId",e.userId);return t!==void 0?{userId:t}:{}}function Kt(s){if(s==null)return{};let e=C("getEnrollments",s),t=N("getEnrollments","userId",e.userId);return t!==void 0?{userId:t}:{}}function Pt(s){let e=C("getPublicKey",s);return{kid:K("getPublicKey","kid",e.kid)}}function St(s){let e=C("getUserLeases",s);return{userId:K("getUserLeases","userId",e.userId)}}function At(s){let e=C("verifyLease",s),t={leaseId:K("verifyLease","leaseId",e.leaseId)};if("deleteIfInvalid"in e){if(typeof e.deleteIfInvalid!="boolean")throw new Error("verifyLease: deleteIfInvalid must be a boolean");t.deleteIfInvalid=e.deleteIfInvalid}return t}function Et(s){let e=C("removeEnrollment",s);return{enrollmentId:K("removeEnrollment","enrollmentId",e.enrollmentId),credentials:G("removeEnrollment",e.credentials)}}function as(s,e){if(typeof e!="object"||e===null)throw new E(s,"subscription","object",e);let t=e,r=K(s,"subscription.endpoint",t.endpoint);if(!r.startsWith("https://"))throw new Error(`${s}: subscription.endpoint must use HTTPS`);let n;try{n=new URL(r)}catch{throw new Error(`${s}: subscription.endpoint is not a valid URL`)}if(!ns.some(p=>n.hostname===p||n.hostname.endsWith(`.${p}`)))throw new Error(`${s}: subscription.endpoint must be from a known push service (FCM, APNs, Mozilla Push, WNS). Got: ${n.hostname}`);let o=t.expirationTime;if(o!==null&&typeof o!="number")throw new E(s,"subscription.expirationTime","number or null",o);if(typeof t.keys!="object"||t.keys===null)throw new E(s,"subscription.keys","object",t.keys);let d=t.keys,i=K(s,"subscription.keys.p256dh",d.p256dh),u=K(s,"subscription.keys.auth",d.auth);if(i.length===0)throw new Error(`${s}: subscription.keys.p256dh must be non-empty`);if(u.length===0)throw new Error(`${s}: subscription.keys.auth must be non-empty`);let l=K(s,"subscription.eid",t.eid);if(l.length===0)throw new Error(`${s}: subscription.eid must be non-empty`);let c=t.createdAt;if(typeof c!="number")throw new E(s,"subscription.createdAt","number",c);return{endpoint:r,expirationTime:o,keys:{p256dh:i,auth:u},eid:l,createdAt:c}}function Ct(s){let e=C("setPushSubscription",s);return{subscription:as("setPushSubscription",e.subscription)}}var E,ns,xt=O(()=>{"use strict";E=class extends Error{constructor(t,r,n,a){super(`RPC ${t}: Invalid ${r} - expected ${n}, got ${typeof a}`);this.method=t;this.param=r;this.expected=n;this.received=a;this.name="RPCValidationError"}};ns=["fcm.googleapis.com","web.push.apple.com","updates.push.services.mozilla.com","notify.windows.com"]});function os(s){if(typeof s!="object"||s===null)return!1;let e=s;return typeof e.tokensIssued=="number"&&typeof e.lastResetAt=="number"}function Rt(s){return os(s)?s:{tokensIssued:0,lastResetAt:Date.now()}}var Mt=O(()=>{"use strict"});var Ft={};Jt(Ft,{handleMessage:()=>Lt});async function ds(s,e){let t=await crypto.subtle.importKey("raw",s,"HKDF",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:e,info:new TextEncoder().encode("ATS/KMS/SessionKEK/v1")},t,{name:"AES-GCM",length:256},!1,["wrapKey","unwrapKey"])}async function Be(){let s=await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),e=await crypto.subtle.exportKey("raw",s.publicKey),t=crypto.randomUUID(),r=crypto.getRandomValues(new Uint8Array(32)),n=crypto.getRandomValues(new Uint8Array(32));return F.set(t,{privateKey:s.privateKey,appSalt:r,hkdfSalt:n,createdAt:Date.now()}),setTimeout(()=>{F.delete(t)},10*60*1e3),{publicKey:h(e),keyId:t,appSalt:h(r.buffer),hkdfSalt:h(n.buffer)}}async function us(s){let e=F.get(s.transportKeyId);if(!e)throw new Error("Transport key not found or expired");let t=A(s.ephemeralPublicKey),r=await crypto.subtle.importKey("raw",t,{name:"ECDH",namedCurve:"P-256"},!1,[]),n=await crypto.subtle.deriveBits({name:"ECDH",public:r},e.privateKey,256),a=await crypto.subtle.importKey("raw",n,"HKDF",!1,["deriveBits"]),o=await crypto.subtle.deriveBits({name:"HKDF",salt:new Uint8Array(32),info:new TextEncoder().encode("ATS/KMS/setup-transport/v2"),hash:"SHA-256"},a,256),d=await crypto.subtle.importKey("raw",o,{name:"AES-GCM",length:256},!1,["decrypt"]),i=A(s.iv),u=A(s.encryptedCredentials),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:i,tagLength:128},d,u),c=JSON.parse(new TextDecoder().decode(l)),p,y;if(s.method==="passphrase"){let f=c;p=await Ut({userId:s.userId,passphrase:f.passphrase},s.requestId),y={method:"passphrase",passphrase:f.passphrase,userId:s.userId}}else if(s.method==="passkey-prf"){let f=c,w=A(f.prfOutput);p=await Tt({userId:s.userId,credentialId:A(f.credentialId),prfOutput:w,...f.rpId!==void 0&&{rpId:f.rpId},appSalt:e.appSalt,hkdfSalt:e.hkdfSalt},s.requestId),y={method:"passkey-prf",prfOutput:w,userId:s.userId}}else if(s.method==="passkey-gate"){let f=c;p=await qt({userId:s.userId,credentialId:A(f.credentialId),...f.rpId!==void 0&&{rpId:f.rpId}},s.requestId),y={method:"passkey-gate",userId:s.userId}}else{let f=s.method;throw new Error(`Unknown method: ${String(f)}`)}return F.delete(s.transportKeyId),{...p,credentials:y}}async function Dt(s,e){let t=await Be(),r=new URL("https://kms.ats.run/");r.searchParams.set("mode","setup");let a=await new Promise((d,i)=>{let u=setTimeout(()=>{i(new Error("Setup with popup timeout"))},3e5);J.set(e,{resolve:d,reject:i,timeout:u}),self.postMessage({type:"worker:setup-with-popup",requestId:e,userId:s.userId,popupURL:r.toString(),transportKey:t.publicKey,transportKeyId:t.keyId,appSalt:t.appSalt,hkdfSalt:t.hkdfSalt})});return await us({method:a.method,transportKeyId:a.transportKeyId,ephemeralPublicKey:a.ephemeralPublicKey,iv:a.iv,encryptedCredentials:a.encryptedCredentials,userId:a.userId,requestId:e})}async function ls(s,e){let{userId:t,autoExtend:r=!0,ttlHours:n=12}=s;if(n<=0||n>720)throw new Error("ttlHours must be between 0 and 720 (30 days)");if(await Re(t))throw new Error("User already has authentication setup. Use addEnrollment to add additional methods.");let o=await Dt({userId:t},`${e}-setup`),d=o.credentials,i=o.vapidPublicKey,u=o.vapidKid,l=o.enrollmentId,c=await new Promise((w,g)=>{let m=setTimeout(()=>{g(new Error("Push subscription timeout (60s)"))},6e4),k=`${e}-push-sub`;te.set(k,{resolve:w,reject:g,timeout:m}),self.postMessage({type:"worker:request-push-subscription",requestId:k,vapidPublicKey:i,userId:t})});await Wt({subscription:c});let p=await Bt({userId:t,ttlHours:n,credentials:d,autoExtend:r},`${e}-lease`),f=(await Ot({leaseId:p.leaseId,count:5,kid:u},`${e}-jwts`)).map(w=>({jwt:w.jwt,jti:w.jti,exp:w.exp}));try{let w=f[0];await new Promise((g,m)=>{let k=setTimeout(()=>{m(new Error("Test notification timeout (30s)"))},3e4),P=`${e}-test-notif`;te.set(P,{resolve:g,reject:m,timeout:k}),self.postMessage({type:"worker:send-test-notification",requestId:P,jwt:w.jwt,subscription:c})})}catch(w){console.warn("[KMS Worker] Test notification failed (non-fatal):",L(w))}return d.method==="passphrase"?d.passphrase="":d.method==="passkey-prf"&&new Uint8Array(d.prfOutput).fill(0),await M({op:"full-setup",kid:u,requestId:e,userId:t,details:{action:"full-setup",enrollmentId:l,leaseId:p.leaseId,autoExtend:r,ttlHours:n,jwtCount:f.length}}),{success:!0,enrollmentId:l,vapidPublicKey:i,vapidKid:u,leaseId:p.leaseId,leaseExp:p.exp,autoExtend:p.autoExtend??!0,jwts:f,subscription:c}}async function Lt(s){let{id:e,method:t,params:r}=s;try{let n;switch(t){case"setupWithPopup":{let a=await Dt(lt(r),e),{credentials:o,...d}=a;n=d;break}case"fullSetup":n=await ls(ct(r),e);break;case"setupPassphrase":n=await Ut(dt(r),e);break;case"setupPasskeyPRF":n=await Tt(ut(r),e);break;case"setupPasskeyGate":n=await qt(pt(r),e);break;case"addEnrollment":n=await cs(yt(r),e);break;case"addEnrollmentWithPopup":n=await ps(ft(r),e);break;case"generateVAPID":n=await ys(wt(r),e);break;case"regenerateVAPID":n=await fs(gt(r),e);break;case"signJWT":n=await ws(mt(r),e);break;case"createLease":n=await Bt(ht(r),e);break;case"extendLeases":n=await gs(kt(r),e);break;case"issueVAPIDJWT":n=await Vt(bt(r),e);break;case"issueVAPIDJWTs":n=await Ot(It(r),e);break;case"isSetup":n=await ms(vt(r));break;case"getEnrollments":n=await hs(Kt(r));break;case"verifyAuditChain":n=await ks();break;case"getAuditLog":n=await bs();break;case"getPublicKey":n=await Is(Pt(r));break;case"getAuditPublicKey":n=await vs();break;case"getUserLeases":n=await Ks(St(r));break;case"verifyLease":n=await Ps(At(r));break;case"getVAPIDKid":n=await Ss();break;case"resetKMS":n=await Cs();break;case"removeEnrollment":n=await xs(Et(r),e);break;case"setPushSubscription":n=await Wt(Ct(r));break;case"removePushSubscription":n=await As();break;case"getPushSubscription":n=await Es();break;default:throw new Error(`Unknown RPC method: ${t}`)}return{id:e,result:n}}catch(n){return{id:e,error:L(n)}}}async function Ut(s,e){let{userId:t,passphrase:r,existingMS:n}=s;if(!r||r.length<8)throw new Error("Passphrase must be at least 8 characters");let a=await he(t,r,n);if(!a.success)throw new Error(a.error);let o=await ie(a.ms);await q(o);let d=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]);if(!("privateKey"in d)||!("publicKey"in d))throw new Error("Failed to generate ECDSA keypair");let i=d,u=await crypto.subtle.exportKey("raw",i.publicKey),l=z(new Uint8Array(u)),c=await Q(l);return await B(i.privateKey,o,c,{name:"ECDSA",namedCurve:"P-256"},["sign"],{alg:"ES256",purpose:"vapid",publicKeyRaw:u}),a.ms.fill(0),await M({op:"setup-passphrase",kid:"",requestId:e,userId:t,details:{method:"passphrase",vapidKid:c}}),{success:!0,enrollmentId:"enrollment:passphrase:v2",vapidPublicKey:h(u),vapidKid:c}}async function Tt(s,e){let{userId:t,credentialId:r,prfOutput:n,rpId:a="",existingMS:o,appSalt:d,hkdfSalt:i}=s;if(!r||r.byteLength===0)throw new Error("credentialId required");if(!n||n.byteLength!==32)throw new Error("prfOutput must be 32 bytes");let u=await ke(t,r,n,o,a,d,i);if(!u.success)throw new Error(u.error);let l=await ie(u.ms);await q(l);let c=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]);if(!("privateKey"in c)||!("publicKey"in c))throw new Error("Failed to generate ECDSA keypair");let p=c,y=await crypto.subtle.exportKey("raw",p.publicKey),f=z(new Uint8Array(y)),w=await Q(f);return await B(p.privateKey,l,w,{name:"ECDSA",namedCurve:"P-256"},["sign"],{alg:"ES256",purpose:"vapid",publicKeyRaw:y}),u.ms.fill(0),await M({op:"setup-passkey-prf",kid:"",requestId:e,userId:t,details:{method:"passkey-prf",credentialId:h(r),vapidKid:w}}),{success:!0,enrollmentId:"enrollment:passkey-prf:v2",vapidPublicKey:h(y),vapidKid:w}}async function qt(s,e){let{userId:t,credentialId:r,rpId:n="",existingMS:a}=s;if(!r||r.byteLength===0)throw new Error("credentialId required");let o=await be(t,r,a,n);if(!o.success)throw new Error(o.error);let d=await ie(o.ms);await q(d);let i=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]);if(!("privateKey"in i)||!("publicKey"in i))throw new Error("Failed to generate ECDSA keypair");let u=i,l=await crypto.subtle.exportKey("raw",u.publicKey),c=z(new Uint8Array(l)),p=await Q(c);return await B(u.privateKey,d,p,{name:"ECDSA",namedCurve:"P-256"},["sign"],{alg:"ES256",purpose:"vapid",publicKeyRaw:l}),o.ms.fill(0),await M({op:"setup-passkey-gate",kid:"",requestId:e,userId:t,details:{method:"passkey-gate",credentialId:h(r),vapidKid:p}}),{success:!0,enrollmentId:"enrollment:passkey-gate:v2",vapidPublicKey:h(l),vapidKid:p}}async function cs(s,e){let{userId:t,credentials:r}=s,a=(await V(r,async(v,D)=>(await q(v),D))).result,o=await Be(),d=new URL("https://kms.ats.run/");d.searchParams.set("mode","setup");let u=await new Promise((v,D)=>{let _=setTimeout(()=>{console.error("[Worker] Popup timeout after 5 minutes"),D(new Error("Add enrollment popup timeout"))},3e5);J.set(e,{resolve:v,reject:D,timeout:_}),self.postMessage({type:"worker:setup-with-popup",requestId:e,userId:s.userId,popupURL:d.toString(),transportKey:o.publicKey,transportKeyId:o.keyId,appSalt:o.appSalt,hkdfSalt:o.hkdfSalt})}),l=F.get(u.transportKeyId);if(!l)throw new Error("Transport key not found or expired");let c=A(u.ephemeralPublicKey),p=await crypto.subtle.importKey("raw",c,{name:"ECDH",namedCurve:"P-256"},!1,[]),y=await crypto.subtle.deriveBits({name:"ECDH",public:p},l.privateKey,256),f=await crypto.subtle.importKey("raw",y,"HKDF",!1,["deriveBits"]),w=await crypto.subtle.deriveBits({name:"HKDF",salt:new Uint8Array(32),info:new TextEncoder().encode("ATS/KMS/setup-transport/v2"),hash:"SHA-256"},f,256),g=await crypto.subtle.importKey("raw",w,{name:"AES-GCM",length:256},!1,["decrypt"]),m=A(u.iv),k=A(u.encryptedCredentials),P=await crypto.subtle.decrypt({name:"AES-GCM",iv:m,tagLength:128},g,k),S=JSON.parse(new TextDecoder().decode(P));F.delete(u.transportKeyId);let I=u.method,b;if(I==="passphrase")b=await he(t,S.passphrase,a);else if(I==="passkey-prf"){let v=S,D=v.rpId||"";b=await ke(t,A(v.credentialId),A(v.prfOutput),a,D)}else if(I==="passkey-gate"){let v=S,D=v.rpId||"";b=await be(t,A(v.credentialId),a,D)}else{let v=I;throw new Error(`Unknown enrollment method: ${String(v)}`)}if(a.fill(0),!b.success)throw new Error(b.error);return await M({op:"add-enrollment",kid:"",requestId:e,userId:r.userId,details:{method:I,action:"add-enrollment"}}),{success:!0,enrollmentId:`enrollment:${I}:v2`}}async function ps(s,e){let{userId:t}=s,r=await Be(),n=new URL("https://kms.ats.run/");n.searchParams.set("mode","setup");let a=await new Promise((I,b)=>{let v=setTimeout(()=>{console.error("[Worker] Popup timeout after 5 minutes"),b(new Error("Add enrollment popup timeout"))},3e5);J.set(e,{resolve:I,reject:b,timeout:v}),self.postMessage({type:"worker:setup-with-popup",requestId:e,userId:t,popupURL:n.toString(),transportKey:r.publicKey,transportKeyId:r.keyId,appSalt:r.appSalt,hkdfSalt:r.hkdfSalt})}),o=F.get(a.transportKeyId);if(!o)throw new Error("Transport key not found or expired");let d=A(a.ephemeralPublicKey),i=await crypto.subtle.importKey("raw",d,{name:"ECDH",namedCurve:"P-256"},!1,[]),u=await crypto.subtle.deriveBits({name:"ECDH",public:i},o.privateKey,256),l=await crypto.subtle.importKey("raw",u,"HKDF",!1,["deriveBits"]),c=await crypto.subtle.deriveBits({name:"HKDF",salt:new Uint8Array(32),info:new TextEncoder().encode("ATS/KMS/setup-transport/v2"),hash:"SHA-256"},l,256),p=await crypto.subtle.importKey("raw",c,{name:"AES-GCM",length:256},!1,["decrypt"]),y=A(a.iv),f=A(a.encryptedCredentials),w=await crypto.subtle.decrypt({name:"AES-GCM",iv:y,tagLength:128},p,f),g=JSON.parse(new TextDecoder().decode(w));F.delete(a.transportKeyId);let m=await new Promise((I,b)=>{let v=setTimeout(()=>{console.error("[Worker] Unlock timeout after 5 minutes"),b(new Error("Unlock modal timeout"))},3e5);ue.set(e,{resolve:I,reject:b,timeout:v}),self.postMessage({type:"worker:request-unlock",requestId:e,userId:t})}),P=(await V(m,async(I,b)=>(await q(I),new Uint8Array(b)))).result,S=a.method;try{let I;if(S==="passphrase")I=await he(t,g.passphrase,P);else if(S==="passkey-prf"){let b=g,v=b.rpId||"";I=await ke(t,A(b.credentialId),A(b.prfOutput),P,v)}else if(S==="passkey-gate"){let b=g,v=b.rpId||"";I=await be(t,A(b.credentialId),P,v)}else{let b=S;throw new Error(`Unknown enrollment method: ${String(b)}`)}if(!I.success)throw new Error(I.error)}finally{P.fill(0)}return await M({op:"add-enrollment-with-popup",kid:"",requestId:e,userId:t,details:{method:S,action:"add-enrollment-with-popup"}}),{success:!0,enrollmentId:`enrollment:${S}:v2`}}async function ys(s,e){let{credentials:t}=s,r=await V(t,async(n,a)=>{await q(n);let o=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]);if(!("privateKey"in o)||!("publicKey"in o))throw new Error("Failed to generate ECDSA keypair");let d=o,i=await crypto.subtle.exportKey("raw",d.publicKey),u=z(new Uint8Array(i)),l=await Q(u);return await B(d.privateKey,n,l,{name:"ECDSA",namedCurve:"P-256"},["sign"],{alg:"ES256",purpose:"vapid",publicKeyRaw:i}),{kid:l,publicKey:h(i)}});return await M({op:"generate",kid:r.result.kid,requestId:e,userId:t.userId,unlockTime:r.unlockTime,lockTime:r.lockTime,duration:r.duration,details:{algorithm:"ECDSA",curve:"P-256",purpose:"vapid"}}),r.result}async function fs(s,e){let{credentials:t}=s,r=await V(t,async(n,a)=>{await q(n);let d=(await U()).filter(y=>y.purpose==="vapid");for(let y of d)await Ge(y.kid);let i=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]);if(!("privateKey"in i)||!("publicKey"in i))throw new Error("Failed to generate ECDSA keypair");let u=i,l=await crypto.subtle.exportKey("raw",u.publicKey),c=z(new Uint8Array(l)),p=await Q(c);return await B(u.privateKey,n,p,{name:"ECDSA",namedCurve:"P-256"},["sign"],{alg:"ES256",purpose:"vapid",publicKeyRaw:l}),{kid:p,publicKey:h(l),oldKids:d.map(y=>y.kid)}});return await M({op:"regenerate-vapid",kid:r.result.kid,requestId:e,userId:t.userId,unlockTime:r.unlockTime,lockTime:r.lockTime,duration:r.duration,details:{algorithm:"ECDSA",curve:"P-256",purpose:"vapid",oldKids:r.result.oldKids,deletedCount:r.result.oldKids.length}}),{kid:r.result.kid,publicKey:r.result.publicKey}}async function ws(s,e){let{kid:t,payload:r,credentials:n}=s;if(!r.aud||!r.sub||!r.exp)throw new Error("JWT payload must include aud, sub, and exp");let a=Math.floor(Date.now()/1e3);if(r.exp<=a)throw new Error("JWT exp must be in the future");if(r.exp>a+86400)throw new Error("JWT exp must be <= 24 hours (RFC 8292)");let o=await V(n,async(d,i)=>{await q(d);let u=await Ne(t,d,{name:"ECDSA",namedCurve:"P-256"},["sign"]),l={typ:"JWT",alg:"ES256",kid:t},c=h(new TextEncoder().encode(JSON.stringify(l)).buffer),p=h(new TextEncoder().encode(JSON.stringify(r)).buffer),y=new TextEncoder().encode(`${c}.${p}`),f=await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},u,y),w=h(f);return{jwt:`${c}.${p}.${w}`}});return await M({op:"sign",kid:t,requestId:e,userId:n.userId,unlockTime:o.unlockTime,lockTime:o.lockTime,duration:o.duration,details:{algorithm:"ES256",aud:r.aud,exp:r.exp,jti:r.jti}}),o.result}async function Bt(s,e){let{userId:t,ttlHours:r,credentials:n,autoExtend:a}=s;if(r<=0||r>720)throw new Error("ttlHours must be between 0 and 720 (30 days)");let d=(await U()).filter(m=>m.purpose==="vapid");if(d.length===0)throw new Error("No VAPID key found. VAPID key should have been generated during setup.");d.sort((m,k)=>k.createdAt-m.createdAt);let i=d[0];if(!i)throw new Error("VAPID key record not found after filtering");let u=i.kid,l=`lease-${crypto.randomUUID()}`,c=crypto.getRandomValues(new Uint8Array(32)),p=Date.now(),y=p+r*3600*1e3,f=await V(n,async(m,k)=>{await q(m);let{delegationCert:P}=await et(l,y),S=await ds(k,c),I=await W(u);if(!I)throw new Error(`No wrapped key with id: ${u}`);let b=new Uint8Array(I.iv),v=I.aad,D=await crypto.subtle.unwrapKey("pkcs8",I.wrappedKey,m,{name:"AES-GCM",iv:b,additionalData:v},{name:"ECDSA",namedCurve:"P-256"},!0,["sign"]),_=crypto.getRandomValues(new Uint8Array(12));return{wrappedLeaseKey:await crypto.subtle.wrapKey("pkcs8",D,S,{name:"AES-GCM",iv:_}),iv:_,sessionKEK:S,lakDelegationCert:P}});await T(`sessionkek:${l}`,f.result.sessionKEK),qe.set(l,f.result.sessionKEK);let w={tokensPerHour:100,sendsPerMinute:10,burstSends:20,sendsPerMinutePerEid:5},g={leaseId:l,userId:t,ttlHours:r,createdAt:p,exp:y,autoExtend:a??!0,quotas:w,wrappedLeaseKey:f.result.wrappedLeaseKey,wrappedLeaseKeyIV:f.result.iv.buffer.slice(f.result.iv.byteOffset,f.result.iv.byteOffset+f.result.iv.byteLength),leaseSalt:c.buffer.slice(c.byteOffset,c.byteOffset+c.byteLength),kid:u,lakDelegationCert:f.result.lakDelegationCert};return await Ae(g),await T(`quota:${l}`,{leaseId:l,tokensIssued:0,lastResetAt:p,perEndpoint:{}}),await M({op:"create-lease",kid:u,requestId:e,userId:t,details:{action:"create-lease",leaseId:l,userId:t,ttlHours:r,autoExtend:g.autoExtend}}),{leaseId:l,exp:y,quotas:w,autoExtend:g.autoExtend??!0}}async function gs(s,e){let{leaseIds:t,credentials:r,requestAuth:n}=s,a=[],o=0,d=0,i=0,u=!1;if(r)try{await V(r,async(l,c)=>(u=!0,Promise.resolve()))}catch(l){for(let c of t){let p=await ne(c);p&&p.autoExtend===!1&&(a.push({leaseId:c,status:"skipped",reason:`Authentication failed: ${L(l)}`}),d++)}if(d===t.length)return{results:a,extended:o,skipped:d,failed:i}}for(let l of t)try{let c=await ne(l);if(!c){a.push({leaseId:l,status:"skipped",reason:`Lease not found: ${l}`}),d++;continue}if(c.autoExtend===!1&&!n){a.push({leaseId:l,status:"skipped",reason:"Lease has autoExtend=false and authentication was not requested"}),d++;continue}if(c.autoExtend===!1&&n&&!u){a.push({leaseId:l,status:"skipped",reason:"Authentication required but credentials not valid"}),d++;continue}let y=(await U()).filter(P=>P.purpose==="vapid");if(y.length===0){a.push({leaseId:l,status:"skipped",reason:"No VAPID key found"}),d++;continue}y.sort((P,S)=>S.createdAt-P.createdAt);let w=y[0].kid;if(c.kid!==w){a.push({leaseId:l,status:"skipped",reason:`Lease is for different VAPID key (lease kid: ${c.kid}, current kid: ${w})`}),d++;continue}let g=Date.now(),m=g+30*24*60*60*1e3,k={...c,exp:m,createdAt:g};await Ae(k),await M({op:"extend-lease",kid:k.kid,requestId:e,userId:k.userId,details:{action:"extend-lease",leaseId:k.leaseId,userId:k.userId,newExp:m,autoExtend:k.autoExtend}}),a.push({leaseId:l,status:"extended",result:{leaseId:k.leaseId,exp:k.exp,iat:k.createdAt,kid:k.kid,autoExtend:k.autoExtend??!1}}),o++}catch(c){a.push({leaseId:l,status:"skipped",reason:`Error extending lease: ${L(c)}`}),i++}return{results:a,extended:o,skipped:d,failed:i}}async function Vt(s,e){let{leaseId:t}=s,{kid:r}=s;if(!r){let se=(await U()).filter(Nt=>Nt.purpose==="vapid");if(se.length===0)throw new Error("No VAPID key found. Create a lease first to auto-generate one.");if(se.length>1)throw new Error("Multiple VAPID keys found. Please specify kid explicitly.");let We=se[0];if(!We)throw new Error("No VAPID key found after filtering");r=We.kid}let n=await ne(t);if(!n)throw new Error(`Lease not found: ${t}`);if(Date.now()>=n.exp)throw new Error("Lease expired");let o=(await U()).filter(H=>H.purpose==="vapid");if(o.length===0)throw new Error("No VAPID key available");o.sort((H,se)=>se.createdAt-H.createdAt);let d=o[0]?.kid;if(!d)throw new Error("Failed to determine current VAPID key");if(n.kid!==d)throw new Error("Lease invalidated by VAPID key rotation (wrong-key)");await tt(t,n.lakDelegationCert);let i=await Ce();if(!i)throw new Error("No push subscription found. Call setPushSubscription() first.");let u=await x(`quota:${t}`),l=Rt(u),c=Date.now()-3600*1e3;if(l.lastResetAt<c&&(l.tokensIssued=0,l.lastResetAt=Date.now()),l.tokensIssued>=n.quotas.tokensPerHour)throw new Error("Quota exceeded: tokens per hour");l.tokensIssued++,await T(`quota:${t}`,l);let p=s.jti??crypto.randomUUID(),y=s.exp??Math.floor(Date.now()/1e3)+900,f=new URL(i.endpoint),w=`${f.protocol}//${f.host}`,g={aud:w,sub:"mailto:kms@example.com",exp:y,jti:p,uid:n.userId,eid:i.eid},m=qe.get(t);if(!m){let H=await x(`sessionkek:${t}`);if(!H)throw new Error(`SessionKEK not found for lease: ${t}`);m=H,qe.set(t,m)}let k=n.wrappedLeaseKey,P=new Uint8Array(n.wrappedLeaseKeyIV),S=await crypto.subtle.unwrapKey("pkcs8",k,m,{name:"AES-GCM",iv:P},{name:"ECDSA",namedCurve:"P-256"},!1,["sign"]),I={typ:"JWT",alg:"ES256",kid:n.kid},b=h(new TextEncoder().encode(JSON.stringify(I)).buffer),v=h(new TextEncoder().encode(JSON.stringify(g)).buffer),D=new TextEncoder().encode(`${b}.${v}`),_=await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},S,D),Oe=h(_),jt=`${b}.${v}.${Oe}`,$t=await M({op:"sign",kid:n.kid,requestId:e,userId:n.userId,leaseId:t,details:{action:"issue-lease-jwt",jti:p,aud:w,eid:i.eid}});return{jwt:jt,jti:p,exp:y,auditEntry:$t}}async function Ot(s,e){let{leaseId:t,count:r,kid:n}=s;if(!Number.isInteger(r)||r<1||r>10)throw new Error("count must be an integer between 1 and 10");let a=900,o=Math.floor(a*.6),d=Math.floor(Date.now()/1e3),i=[];for(let u=0;u<r;u++){let l=crypto.randomUUID(),c=d+a+u*o,p=await Vt({leaseId:t,...n!==void 0&&{kid:n},jti:l,exp:c},`${e}-${u}`);i.push(p)}return i}async function ms(s){let e=s?.userId??"default",t=await Re(e),r=[];await Me(e)&&r.push("passphrase"),await De(e)&&r.push("passkey");let n;return t&&s?.userId&&(n=await Ee(s.userId)),{isSetup:t,methods:r,...n!==void 0&&{leases:n}}}async function hs(s){let e=s?.userId??"default",t=[];if(await Me(e)&&t.push("enrollment:passphrase:v2"),await De(e)){let r=await x(`enrollment:passkey-prf:v2:${e}`),n=await x(`enrollment:passkey-gate:v2:${e}`);r&&t.push("enrollment:passkey-prf:v2"),n&&t.push("enrollment:passkey-gate:v2")}return{enrollments:t}}async function ks(){return await rt()}async function bs(){return{entries:await ee()}}async function Is(s){let{kid:e}=s,t=await W(e);if(!t||!t.publicKeyRaw)throw new Error(`Public key not found for kid: ${e}`);return{publicKey:h(t.publicKeyRaw)}}async function vs(){return await nt()}async function Ks(s){let{userId:e}=s;return{leases:await Ee(e)}}async function Ps(s){let{leaseId:e,deleteIfInvalid:t=!1}=s,r=await ne(e);if(!r)return{leaseId:e,valid:!1,reason:"not-found",kid:""};if(Date.now()>=r.exp)return t&&await ae(e),{leaseId:e,valid:!1,reason:"expired",kid:r.kid};let a=(await U()).filter(i=>i.purpose==="vapid");if(a.length===0)return t&&await ae(e),{leaseId:e,valid:!1,reason:"no-vapid-key",kid:r.kid};a.sort((i,u)=>u.createdAt-i.createdAt);let o=a[0];if(!o)return t&&await ae(e),{leaseId:e,valid:!1,reason:"no-vapid-key",kid:r.kid};let d=o.kid;return r.kid!==d?(t&&await ae(e),{leaseId:e,valid:!1,reason:"wrong-key",kid:r.kid}):{leaseId:e,valid:!0,kid:r.kid}}async function Ss(){let e=(await U()).filter(r=>r.purpose==="vapid");if(e.length===0)throw new Error("No VAPID key found");if(e.length>1)throw new Error("Multiple VAPID keys found. Please use getPublicKey(kid) with explicit kid.");let t=e[0];if(!t)throw new Error("No VAPID key found after filtering");return{kid:t.kid}}async function Wt(s){return await Qe(s.subscription),{success:!0}}async function As(){return await Ye(),{success:!0}}async function Es(){return{subscription:await Ce()}}async function Cs(){$e();let s=indexedDB.deleteDatabase("kms-v2");return await new Promise((e,t)=>{s.onsuccess=()=>e(),s.onerror=()=>t(new Error(s.error?.message??"Failed to delete database"))}),await pe(),at(),{success:!0}}async function xs(s,e){let{enrollmentId:t,credentials:r}=s;return await V(r,async(n,a)=>(await q(n),!0)),await Je(t),await M({op:"reset",kid:"",requestId:e,userId:r.userId,details:{action:"remove-enrollment",enrollmentId:t}}),{success:!0}}var qe,F,J,ue,te,Ht=O(()=>{"use strict";Xe();it();fe();Y();Ke();xt();Mt();qe=new Map,F=new Map,J=new Map,ue=new Map,te=new Map;self.addEventListener("message",s=>{let e=s.data;if("type"in e&&e.type==="worker:popup-credentials"){let t=e.requestId;if(t&&e.credentials){let r=J.get(t);r&&(clearTimeout(r.timeout),J.delete(t),r.resolve(e.credentials))}return}if("type"in e&&e.type==="worker:popup-error"){let t=e.requestId;if(t){let r=J.get(t);r&&(clearTimeout(r.timeout),J.delete(t),r.reject(new Error(e.reason||"Popup setup failed")))}return}if("type"in e&&e.type==="worker:unlock-credentials"){let t=e.requestId,r=e.credentials;if(t&&r){let n=ue.get(t);n&&(clearTimeout(n.timeout),ue.delete(t),n.resolve(r))}return}if("type"in e&&e.type==="worker:unlock-error"){let t=e.requestId;if(t){let r=ue.get(t);r&&(clearTimeout(r.timeout),ue.delete(t),r.reject(new Error(e.reason||"Unlock failed")))}return}if("type"in e&&e.type==="worker:push-subscription-result"){let t=e,r=t.requestId,n=t.subscription,a=t.error;if(r){let o=te.get(r);o&&(clearTimeout(o.timeout),te.delete(r),n?o.resolve(n):o.reject(new Error(a||"Push subscription failed")))}return}if("type"in e&&e.type==="worker:test-notification-result"){let t=e,r=t.requestId,n=t.success,a=t.error;if(r){let o=te.get(r);o&&(clearTimeout(o.timeout),te.delete(r),n?o.resolve(void 0):o.reject(new Error(a||"Test notification failed")))}return}(async()=>{let t=s.data,r=await Lt(t);self.postMessage(r)})().catch(t=>{console.error("[KMS Worker] Message handling failed:",t);let r=s.data;self.postMessage({id:r?.id||"unknown",error:t instanceof Error?t.message:"Unknown error"})})});(async()=>{try{await pe(),await Ze(),await st(),(await ee()).length===0&&await M({op:"kms-init",kid:"",requestId:`init-${Date.now()}`,userId:"system",details:{kmsVersion:"v2.0.0",timestamp:new Date().toISOString(),note:"KMS worker initialized, KIAK generated"}})}catch(s){console.error("[KMS Worker] Initialization failed:",s)}})()});Ke();function _t(s){if(typeof s!="object"||s===null)return!1;let e=s;if("enabled"in e&&typeof e.enabled!="boolean")return!1;if("results"in e){if(typeof e.results!="object"||e.results===null)return!1;let t=e.results;if("first"in t&&!(t.first instanceof ArrayBuffer)&&!(t.first instanceof Uint8Array)||"second"in t&&!(t.second instanceof ArrayBuffer)&&!(t.second instanceof Uint8Array))return!1}return!0}function j(s){let t=s.getClientExtensionResults().prf;if(t){if(!_t(t)){console.warn("[WebAuthn] Invalid PRF extension result structure:",t);return}return t}}Y();var Ve=class{worker=null;parentOrigin;workerUrl;isInitialized=!1;pendingUnlockRequest=null;pendingUnlockRequestId=null;isStatelessPopup=!1;transportPublicKey=null;transportKeyId=null;appSalt=null;popupState=null;messagePort=null;constructor(e){this.parentOrigin=e.parentOrigin,this.workerUrl=e.workerUrl??"./kms-worker.f3873523.js"}async init(){if(this.isInitialized)throw new Error("KMSClient already initialized");try{let e=new URLSearchParams(window.location.search);this.transportPublicKey=e.get("transportKey"),this.transportKeyId=e.get("keyId"),this.appSalt=e.get("appSalt"),this.popupState=e.get("state");let t=e.get("parentOrigin");this.isStatelessPopup=!!(this.transportPublicKey&&this.transportKeyId),console.log("[KMS Client] Popup detection:",{url:window.location.href,transportKey:this.transportPublicKey?.slice(0,20)+"...",keyId:this.transportKeyId,state:this.popupState,parentOrigin:t,isStatelessPopup:this.isStatelessPopup}),this.isStatelessPopup&&console.log("[KMS Client] Running in stateless popup mode"),window.addEventListener("message",this.handleParentMessage.bind(this)),this.worker=new Worker(this.workerUrl,{type:"module",name:"kms-worker-v2"}),this.worker.addEventListener("message",this.handleWorkerMessage.bind(this)),this.worker.addEventListener("error",this.handleWorkerError.bind(this)),this.isInitialized=!0,this.isStatelessPopup?console.log("[KMS Client] Stateless popup: Ready for two-phase handshake (hello  ready  connect)"):this.sendToParent({type:"kms:ready"})}catch(e){throw console.error("[KMS Client] Initialization failed:",e),new Error(ve("Failed to initialize KMS client",e))}}handleParentMessage(e){if(e.origin!==this.parentOrigin){console.warn("[KMS Client] Rejected message from invalid origin:",{expected:this.parentOrigin,received:e.origin});return}if(e.data?.type==="kms:hello"&&this.isStatelessPopup){if(console.log("[KMS Client] Received kms:hello message"),e.data.state!==this.popupState){console.error("[KMS Client] State mismatch in kms:hello:",{expected:this.popupState,received:e.data.state});return}console.log("[KMS Client] Replying kms:ready to parent"),e.source&&e.source.postMessage({type:"kms:ready",state:this.popupState},e.origin);return}if(e.data?.type==="kms:connect"&&this.isStatelessPopup){if(console.log("[KMS Client] Received kms:connect message with port"),e.data.state!==this.popupState){console.error("[KMS Client] State mismatch in kms:connect:",{expected:this.popupState,received:e.data.state});return}if(!e.ports||e.ports.length===0){console.error("[KMS Client] No MessagePort transferred in kms:connect");return}this.messagePort=e.ports[0]||null,console.log("[KMS Client] MessagePort established successfully"),this.messagePort&&(this.messagePort.postMessage({type:"kms:connected"}),console.log("[KMS Client] Sent kms:connected confirmation to parent"));return}let t=e.data;if(t?.type==="kms:popup-opened"){let a=t.requestId;this.worker?.postMessage({type:"worker:popup-opened",requestId:a});return}if(t?.type==="kms:popup-blocked"){let a=t.requestId,o=t.reason||"Popup was blocked";this.worker?.postMessage({type:"worker:popup-blocked",requestId:a,reason:o});return}if(t?.type==="kms:popup-ready")return;if(t?.type==="kms:push-subscription-result"){let a=t;this.worker?.postMessage({type:"worker:push-subscription-result",requestId:a.requestId,subscription:a.subscription,error:a.error});return}if(t?.type==="kms:test-notification-result"){let a=t;this.worker?.postMessage({type:"worker:test-notification-result",requestId:a.requestId,success:a.success,error:a.error});return}if(!this.isInitialized||!this.worker){console.error("[KMS Client] Received message before initialization");return}let r=e.data,n=["createLease","generateVAPID","signJWT","regenerateVAPID","addEnrollment"];if(r?.method&&n.includes(r.method)){this.showUnlockModal(r);return}if(r?.method==="extendLeases"&&r.params&&typeof r.params=="object"&&"requestAuth"in r.params&&r.params.requestAuth===!0){this.showUnlockModal(r);return}try{this.worker.postMessage(e.data)}catch(a){console.error("[KMS Client] Failed to forward message to Worker:",a),r?.id&&this.sendToParent({id:r.id,error:ve("Failed to forward message",a)})}}handleWorkerMessage(e){try{let t=e.data;if("type"in t&&t.type==="worker:setup-with-popup"){this.handleSetupWithPopup({requestId:t.requestId,userId:t.userId,popupURL:t.popupURL,transportKey:t.transportKey,transportKeyId:t.transportKeyId,appSalt:t.appSalt,hkdfSalt:t.hkdfSalt});return}if("type"in t&&t.type==="worker:request-unlock"){this.handleUnlockRequest({requestId:t.requestId,userId:t.userId});return}if("type"in t&&t.type==="worker:request-push-subscription"){this.handlePushSubscriptionRequest({requestId:t.requestId,vapidPublicKey:t.vapidPublicKey,userId:t.userId});return}if("type"in t&&t.type==="worker:send-test-notification"){this.handleTestNotification({requestId:t.requestId,jwt:t.jwt,subscription:t.subscription});return}if("type"in t&&t.type==="worker:request-popup-from-parent"){this.handleWorkerPopupRequest(t.url,t.requestId);return}this.sendToParent(t)}catch(t){console.error("[KMS Client] Failed to forward message to parent:",t)}}handleWorkerPopupRequest(e,t){if(!this.parentOrigin){this.worker?.postMessage({type:"worker:popup-blocked",requestId:t,reason:"Parent origin not configured"});return}let r=window.parent&&window.parent!==window?window.parent:null;if(!r){this.worker?.postMessage({type:"worker:popup-blocked",requestId:t,reason:"No parent window available"});return}try{r.postMessage({type:"kms:request-popup",url:e,requestId:t},this.parentOrigin)}catch(n){console.error("[KMS Client] Failed to send popup request to parent:",n),this.worker?.postMessage({type:"worker:popup-blocked",requestId:t,reason:n instanceof Error?n.message:"Unknown error"})}}async handleSetupWithPopup(e){try{if(!this.parentOrigin)throw new Error("Parent origin not configured");let t=window.parent&&window.parent!==window?window.parent:null;if(!t)throw new Error("No parent window available");let r=new URL(e.popupURL);r.searchParams.set("parentOrigin",this.parentOrigin),t.postMessage({type:"kms:request-popup",url:r.toString(),requestId:e.requestId},this.parentOrigin);let a=await new Promise((i,u)=>{let l=setTimeout(()=>{u(new Error("Popup ready timeout"))},3e4),c=p=>{let y=p.data;y?.type==="kms:popup-ready"&&y.requestId===e.requestId&&(p.ports&&p.ports.length>0&&p.ports[0]?(clearTimeout(l),window.removeEventListener("message",c),i(p.ports[0])):(clearTimeout(l),window.removeEventListener("message",c),u(new Error("No MessagePort received with popup-ready"))))};window.addEventListener("message",c)}),o=new Promise((i,u)=>{let l=setTimeout(()=>{u(new Error("Credentials timeout"))},3e5);a.onmessage=c=>{let p=c.data;p?.type==="popup:credentials"?(clearTimeout(l),a.close(),i({method:p.method,transportKeyId:p.transportKeyId,userId:p.userId,ephemeralPublicKey:p.ephemeralPublicKey,iv:p.iv,encryptedCredentials:p.encryptedCredentials})):p?.type==="popup:error"?(clearTimeout(l),a.close(),u(new Error(p.reason||"Popup error"))):p?.type==="popup:connected"&&console.log("[KMS Client] Popup connected, waiting for credentials...")}});a.postMessage({type:"kms:connect",transportKey:e.transportKey,transportKeyId:e.transportKeyId,appSalt:e.appSalt,hkdfSalt:e.hkdfSalt,userId:e.userId});let d=await o;this.worker?.postMessage({type:"worker:popup-credentials",requestId:e.requestId,credentials:d})}catch(t){console.error("[KMS Client] Setup with popup failed:",t),this.worker?.postMessage({type:"worker:popup-error",requestId:e.requestId,reason:t instanceof Error?t.message:"Unknown error"})}}handleUnlockRequest(e){try{this.pendingUnlockRequestId=e.requestId,this.sendToParent({type:"kms:show-iframe"}),this.pendingUnlockRequest={id:e.requestId,method:"getEnrollments",params:{userId:e.userId}},this.showUnlockModal(this.pendingUnlockRequest)}catch(t){console.error("[KMS Client] Unlock request failed:",t),this.worker?.postMessage({type:"worker:unlock-error",requestId:e.requestId,reason:t instanceof Error?t.message:"Unknown error"})}}async handlePushSubscriptionRequest(e){try{let t=window.parent&&window.parent!==window?window.parent:null;if(!t)throw new Error("No parent window available");t.postMessage({type:"kms:request-push-subscription",requestId:e.requestId,vapidPublicKey:e.vapidPublicKey,userId:e.userId},this.parentOrigin)}catch(t){console.error("[KMS Client] Push subscription request failed:",t),this.worker?.postMessage({type:"worker:push-subscription-result",requestId:e.requestId,error:t instanceof Error?t.message:"Unknown error"})}}async handleTestNotification(e){try{let t=window.parent&&window.parent!==window?window.parent:null;if(!t)throw new Error("No parent window available");t.postMessage({type:"kms:send-test-notification",requestId:e.requestId,jwt:e.jwt,subscription:e.subscription},this.parentOrigin)}catch(t){console.error("[KMS Client] Test notification request failed:",t),this.worker?.postMessage({type:"worker:test-notification-result",requestId:e.requestId,success:!1,error:t instanceof Error?t.message:"Unknown error"})}}handleWorkerError(e){console.error("[KMS Client] Worker error:",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}sendToParent(e){let t=window.opener&&window.opener!==null&&window.opener!==window,r=window.parent&&window.parent!==window,n=t?window.opener:r?window.parent:null;if(!n){console.error("[KMS Client] No parent/opener window available",{hasValidOpener:t,hasValidParent:r});return}try{n.postMessage(e,this.parentOrigin)}catch(a){console.error("[KMS Client] Failed to send message to parent/opener:",a)}}async getEnrollments(e){return new Promise((t,r)=>{let n=`get-enrollments-${Date.now()}`,a={id:n,method:"getEnrollments",params:{userId:e}},o=d=>{let i=d.data;if(i.id===n)if(this.worker?.removeEventListener("message",o),i.error){let u=typeof i.error=="string"?i.error:i.error.message;r(new Error(u))}else t(i.result?.enrollments||[])};this.worker?.addEventListener("message",o),this.worker?.postMessage(a),setTimeout(()=>{this.worker?.removeEventListener("message",o),r(new Error("getEnrollments timeout"))},5e3)})}showUnlockModal(e){this.pendingUnlockRequest=e;let t=document.getElementById("unlock-modal"),r=document.getElementById("kms-webauthn-btn"),n=document.getElementById("kms-passphrase-input"),a=document.getElementById("kms-passphrase-btn");if(!t||!r||!n||!a){console.error("[KMS Client] Modal elements not found"),e?this.sendToParent({id:e.id,error:"Modal UI not found"}):this.sendToParent({type:"kms:unlock-error",error:"Modal UI not found"});return}t.classList.remove("hidden"),r.onclick=()=>this.handleWebAuthnUnlock(),a.onclick=()=>this.handlePassphraseUnlock(n.value),n.onkeydown=o=>{o.key==="Enter"&&this.handlePassphraseUnlock(n.value).catch(d=>{console.error("[KMS Client] Passphrase unlock failed:",d),this.showError(d instanceof Error?d.message:"Unknown error")})},this.hideError()}async handleWebAuthnUnlock(){this.showLoading(),this.hideError();try{let e=localStorage.getItem("kms:appSalt"),t;e?t=new Uint8Array(e.split(",").map(c=>parseInt(c,10))):t=crypto.getRandomValues(new Uint8Array(32));let r=await navigator.credentials.get({publicKey:{challenge:new Uint8Array(32),timeout:6e4,userVerification:"required",extensions:{prf:{eval:{first:t}}}}});if(!r)throw new Error("No credential returned");let a=j(r)?.results?.first;if(!this.pendingUnlockRequest)throw new Error("No pending operation");let o=this.pendingUnlockRequest.params?.userId;if(!o)throw new Error("userId not found in request params");let d=await this.getEnrollments(o),i=d.includes("enrollment:passkey-prf:v2"),u=d.includes("enrollment:passkey-gate:v2"),l;if(i&&a)l={method:"passkey-prf",prfOutput:a,userId:o};else if(u)l={method:"passkey-gate",userId:o};else throw new Error("No passkey enrollment found for this user");if(this.pendingUnlockRequestId)this.worker?.postMessage({type:"worker:unlock-credentials",requestId:this.pendingUnlockRequestId,credentials:l}),this.pendingUnlockRequestId=null,this.pendingUnlockRequest=null,this.hideModal(),this.hideLoading();else{let c={...this.pendingUnlockRequest,params:{...this.pendingUnlockRequest.params,credentials:l}};this.setupUnlockResponseListener(c),this.worker?.postMessage(c)}}catch(e){this.hideLoading(),this.showError(`WebAuthn failed: ${L(e)}`),console.error("[KMS Client] WebAuthn unlock failed:",e)}}async handlePassphraseUnlock(e){if(!e||e.trim().length===0){this.showError("Please enter a passphrase");return}this.showLoading(),this.hideError();try{if(!this.pendingUnlockRequest)throw new Error("No pending operation");let t=this.pendingUnlockRequest.params?.userId;if(!t)throw new Error("userId not found in request params");if(this.pendingUnlockRequestId)this.worker?.postMessage({type:"worker:unlock-credentials",requestId:this.pendingUnlockRequestId,credentials:{method:"passphrase",passphrase:e,userId:t}}),this.pendingUnlockRequestId=null,this.pendingUnlockRequest=null,this.hideModal(),this.hideLoading();else{let r={...this.pendingUnlockRequest,params:{...this.pendingUnlockRequest.params,credentials:{method:"passphrase",passphrase:e,userId:t}}};this.setupUnlockResponseListener(r),this.worker?.postMessage(r)}}catch(t){console.error("[KMS Client] Passphrase unlock failed:",t),this.hideLoading(),this.showError(`Unlock failed: ${L(t)}`)}}setupUnlockResponseListener(e){let t=r=>{let n=r.data;n.id===e.id&&(this.worker?.removeEventListener("message",t),this.hideModal(),this.sendToParent(n),this.pendingUnlockRequest=null)};this.worker?.addEventListener("message",t)}showError(e){let t=document.getElementById("kms-modal-error");t&&(t.textContent=e,t.classList.remove("hidden"))}hideError(){let e=document.getElementById("kms-modal-error");e&&e.classList.add("hidden")}showLoading(){let e=document.getElementById("kms-modal-loading");e&&e.classList.remove("hidden")}hideLoading(){let e=document.getElementById("kms-modal-loading");e&&e.classList.add("hidden")}hideModal(){let e=document.getElementById("unlock-modal");e&&e.classList.add("hidden");let t=document.getElementById("kms-passphrase-input");t&&(t.value=""),this.hideLoading(),this.hideError()}async promptUnlockForEnrollment(e,t){this.hideSetupSuccess();let r=document.querySelector("#setup-modal .kms-modal-body");if(r){r.querySelectorAll(".kms-auth-option, .kms-divider").forEach(i=>i.classList.add("hidden"));let a=document.createElement("div");a.id="multi-enrollment-unlock",a.className="multi-enrollment-instructions",a.innerHTML=`
        <p class="multi-enrollment-title">
           Multi-Enrollment Authentication Required
        </p>
        <p class="multi-enrollment-description">
          You already have an authentication method set up. Please authenticate with your existing method to add a new one.
        </p>
      `,r.insertBefore(a,r.firstChild);let o=e.some(i=>i.includes("passphrase")),d=e.some(i=>i.includes("passkey"));if(o){let i=document.createElement("div");i.className="kms-auth-option",i.id="temp-passphrase-unlock",i.innerHTML=`
          <label for="temp-passphrase-input" class="kms-input-label">Passphrase</label>
          <input
            type="password"
            id="temp-passphrase-input"
            class="kms-input"
            placeholder="Enter your passphrase"
            autocomplete="off"
          />
          <button id="temp-passphrase-btn" class="kms-auth-btn kms-secondary">
            <span class="kms-auth-icon"></span>
            <span class="kms-auth-label">Unlock with Passphrase</span>
          </button>
        `,r.appendChild(i)}if(d){let i=document.createElement("div");i.className="kms-auth-option",i.id="temp-passkey-unlock",i.innerHTML=`
          <button id="temp-passkey-btn" class="kms-auth-btn kms-primary">
            <span class="kms-auth-icon"></span>
            <span class="kms-auth-label">Unlock with Passkey</span>
          </button>
        `,r.appendChild(i)}}return new Promise(n=>{let a=()=>{document.getElementById("multi-enrollment-unlock")?.remove(),document.getElementById("temp-passphrase-unlock")?.remove(),document.getElementById("temp-passkey-unlock")?.remove(),r?.querySelectorAll(".kms-auth-option, .kms-divider")?.forEach(l=>l.classList.remove("hidden"))},o=document.getElementById("temp-passphrase-btn"),d=document.getElementById("temp-passphrase-input");if(o&&d){let u=()=>{let l=d.value;if(!l){this.showSetupError("Please enter your passphrase");return}a(),n({method:"passphrase",passphrase:l,userId:t})};o.onclick=u,d.onkeydown=l=>{l.key==="Enter"&&u()}}let i=document.getElementById("temp-passkey-btn");i&&(i.onclick=async()=>{try{let u=localStorage.getItem("kms:appSalt"),l;u?l=new Uint8Array(u.split(",").map(m=>parseInt(m,10))):l=crypto.getRandomValues(new Uint8Array(32));let c=await navigator.credentials.get({publicKey:{challenge:new Uint8Array(32),timeout:6e4,userVerification:"required",extensions:{prf:{eval:{first:l}}}}});if(!c)throw new Error("No credential returned");let y=j(c)?.results?.first,f=e.some(m=>m.includes("prf")),w=e.some(m=>m.includes("gate")),g;if(f&&y)g={method:"passkey-prf",prfOutput:y,userId:t};else if(w)g={method:"passkey-gate",userId:t};else throw new Error("Unable to determine passkey method");a(),n(g)}catch(u){this.showSetupError(`Passkey unlock failed: ${L(u)}`)}})})}setupSetupModalHandlers(){let e=document.getElementById("kms-setup-webauthn-btn"),t=document.getElementById("kms-setup-passphrase-input"),r=document.getElementById("kms-setup-passphrase-confirm-input"),n=document.getElementById("kms-setup-passphrase-btn"),a=document.getElementById("kms-passphrase-char-count");if(!e||!t||!r||!n){console.error("[KMS Client] Setup modal elements not found");return}e.onclick=()=>this.handleWebAuthnSetup();let o=document.getElementById("kms-passphrase-match-feedback"),d=()=>{let u=t.value,l=r.value;if(o){if(l.length===0){o.classList.add("hidden");return}o.classList.remove("hidden"),u===l?(o.textContent=" Passphrases match",o.classList.remove("error"),o.classList.add("success")):(o.textContent=" Passphrases do not match",o.classList.remove("success"),o.classList.add("error"))}};t.oninput=()=>{let u=t.value.length,l=12;a&&(a.textContent=`${u} / ${l} characters`,u<l?(a.classList.remove("success"),a.classList.add("error")):(a.classList.remove("error"),a.classList.add("success"))),d()},r.oninput=d,n.onclick=()=>this.handlePassphraseSetup(t.value,r.value);let i=()=>{this.handlePassphraseSetup(t.value,r.value).catch(u=>{console.error("[KMS Client] Passphrase setup failed:",u),this.showSetupError(u instanceof Error?u.message:"Unknown error")})};t.onkeydown=u=>{u.key==="Enter"&&i()},r.onkeydown=u=>{u.key==="Enter"&&i()}}async encryptCredentials(e,t){let r=await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),n=A(t),a=await crypto.subtle.importKey("raw",n,{name:"ECDH",namedCurve:"P-256"},!1,[]),o=await crypto.subtle.deriveBits({name:"ECDH",public:a},r.privateKey,256),d=await crypto.subtle.importKey("raw",o,"HKDF",!1,["deriveBits"]),i=await crypto.subtle.deriveBits({name:"HKDF",salt:new Uint8Array(32),info:new TextEncoder().encode("ATS/KMS/setup-transport/v2"),hash:"SHA-256"},d,256),u=await crypto.subtle.importKey("raw",i,{name:"AES-GCM",length:256},!1,["encrypt"]),l=crypto.getRandomValues(new Uint8Array(12)),c=new TextEncoder().encode(JSON.stringify(e)),p=await crypto.subtle.encrypt({name:"AES-GCM",iv:l,tagLength:128},u,c),y=await crypto.subtle.exportKey("raw",r.publicKey);return{ephemeralPublicKey:h(y),iv:h(l.buffer),encryptedCredentials:h(p)}}async handleWebAuthnSetup(){this.showSetupLoading(),this.hideSetupError();try{let e="demouser@ats.run",t=window.location.hostname;if(this.isStatelessPopup){let p=A(this.appSalt),y=await navigator.credentials.create({publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),rp:{id:t,name:"ATS KMS V2"},user:{id:new TextEncoder().encode(e),name:e,displayName:e},pubKeyCredParams:[{type:"public-key",alg:-7},{type:"public-key",alg:-257}],authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required",residentKey:"required"},extensions:{prf:{eval:{first:p}}}}});if(!y)throw new Error("No credential returned");let f=j(y),w=f?.enabled===!0,g=f?.results?.first,m;if(w)if(g)m="passkey-prf",console.log("[KMS Client] PRF output available from create() (modern platform)");else{console.log("[KMS Client] PRF enabled but no output yet, calling get() (legacy platform)");let I=await navigator.credentials.get({publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),timeout:6e4,userVerification:"required",extensions:{prf:{eval:{first:p}}}}});g=j(I)?.results?.first,g?(m="passkey-prf",console.log("[KMS Client] PRF output obtained from get()")):(m="passkey-gate",console.warn("[KMS Client] PRF enabled but no output from get(), falling back to gate mode"))}else m="passkey-gate",console.log("[KMS Client] PRF not supported by authenticator, using gate mode");let k={credentialId:h(y.rawId),rpId:t};m==="passkey-prf"&&g&&(k.prfOutput=h(g));let P=await this.encryptCredentials(k,this.transportPublicKey),S=this.credentialPort;S?(console.log("[KMS Client] Sending credentials via MessagePort to iframe"),S.postMessage({type:"popup:credentials",method:m,transportKeyId:this.transportKeyId,userId:e,...P}),this.hideSetupLoading(),this.showSetupSuccess()):window.opener&&(console.log("[KMS Client] Sending credentials via window.opener to parent"),window.opener.postMessage({type:"kms:setup-credentials",method:m,transportKeyId:this.transportKeyId,userId:e,...P},this.parentOrigin),this.hideSetupLoading(),this.showSetupSuccess());return}let r=await this.getEnrollments(e),n=null;r.length>0&&(this.hideSetupLoading(),n=await this.promptUnlockForEnrollment(r,e),this.showSetupLoading());let a=crypto.getRandomValues(new Uint8Array(32)),o=await navigator.credentials.create({publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),rp:{id:t,name:"ATS KMS V2"},user:{id:new TextEncoder().encode(e),name:e,displayName:e},pubKeyCredParams:[{type:"public-key",alg:-7},{type:"public-key",alg:-257}],authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required",residentKey:"required"},extensions:{prf:{eval:{first:a}}}}});if(!o)throw new Error("No credential returned");let i=j(o)?.enabled===!0,u;if(i){let p=await navigator.credentials.get({publicKey:{challenge:crypto.getRandomValues(new Uint8Array(32)),timeout:6e4,userVerification:"required",extensions:{prf:{eval:{first:a}}}}});u=j(p)?.results?.first}let l;n?l={id:`add-enrollment-${Date.now()}`,method:"addEnrollment",params:{userId:e,method:i&&u?"passkey-prf":"passkey-gate",credentials:n,newCredentials:{credentialId:o.rawId,...u&&{prfOutput:u},rpId:t}}}:l={id:`setup-${Date.now()}`,method:i&&u?"setupPasskeyPRF":"setupPasskeyGate",params:{userId:e,credentialId:o.rawId,...u&&{prfOutput:u},rpId:t}},this.worker?.postMessage(l);let c=await new Promise((p,y)=>{let f=w=>{let g=w.data;if(g.id===l.id)if(this.worker?.removeEventListener("message",f),g.error){let m=typeof g.error=="string"?g.error:g.error.message;y(new Error(m))}else p(g.result)};this.worker?.addEventListener("message",f),setTimeout(()=>{this.worker?.removeEventListener("message",f),y(new Error("Setup timeout"))},3e4)});this.hideSetupLoading(),this.showSetupSuccess(),localStorage.setItem("kms:appSalt",Array.from(a).toString()),this.notifySetupComplete({method:u?"passkey-prf":"passkey-gate",result:c})}catch(e){this.hideSetupLoading(),this.showSetupError(`WebAuthn setup failed: ${L(e)}`),console.error("[KMS Client] WebAuthn setup failed:",e)}}async handlePassphraseSetup(e,t){if(!e||e.trim().length===0){this.showSetupError("Please enter a passphrase");return}if(e.length<12){this.showSetupError("Passphrase must be at least 12 characters");return}if(!t||t.trim().length===0){this.showSetupError("Please confirm your passphrase");return}if(e!==t){this.showSetupError("Passphrases do not match");return}this.showSetupLoading(),this.hideSetupError();try{let r="demouser@ats.run";if(console.log("[KMS Client] handlePassphraseSetup - isStatelessPopup:",this.isStatelessPopup,{transportKey:this.transportPublicKey?.slice(0,20)+"...",keyId:this.transportKeyId}),this.isStatelessPopup){console.log("[KMS Client] Entering stateless popup flow for passphrase setup"),console.log("[KMS Client] window.opener check:",{hasOpener:!!window.opener,openerIsWindow:window.opener===window,parentOrigin:this.parentOrigin});let i=await this.encryptCredentials({passphrase:e},this.transportPublicKey);console.log("[KMS Client] Credentials encrypted, preparing to send");let u=this.credentialPort;u?(console.log("[KMS Client] Sending credentials via MessagePort to iframe"),u.postMessage({type:"popup:credentials",method:"passphrase",transportKeyId:this.transportKeyId,userId:r,...i}),this.hideSetupLoading(),this.showSetupSuccess()):window.opener?(console.log("[KMS Client] Sending credentials via window.opener to parent"),window.opener.postMessage({type:"kms:setup-credentials",method:"passphrase",transportKeyId:this.transportKeyId,userId:r,...i},this.parentOrigin),this.hideSetupLoading(),this.showSetupSuccess()):(console.error("[KMS Client] No communication channel available"),this.hideSetupLoading(),this.showSetupError("Communication channel not ready. Please try again."));return}let n=await this.getEnrollments(r),a=null;n.length>0&&(this.hideSetupLoading(),a=await this.promptUnlockForEnrollment(n,r),this.showSetupLoading());let o;a?o={id:`add-enrollment-${Date.now()}`,method:"addEnrollment",params:{userId:r,method:"passphrase",credentials:a,newCredentials:{passphrase:e}}}:o={id:`setup-${Date.now()}`,method:"setupPassphrase",params:{userId:r,passphrase:e}},this.worker?.postMessage(o);let d=await new Promise((i,u)=>{let l=c=>{let p=c.data;if(p.id===o.id)if(this.worker?.removeEventListener("message",l),p.error){let y=typeof p.error=="string"?p.error:p.error.message;u(new Error(y))}else i(p.result)};this.worker?.addEventListener("message",l),setTimeout(()=>{this.worker?.removeEventListener("message",l),u(new Error("Setup timeout"))},3e4)});this.hideSetupLoading(),this.showSetupSuccess(),this.notifySetupComplete({method:"passphrase",result:d})}catch(r){this.hideSetupLoading(),this.showSetupError(`Setup failed: ${L(r)}`),console.error("[KMS Client] Passphrase setup failed:",r)}}showSetupError(e){let t=document.getElementById("kms-setup-error");t&&(t.textContent=e,t.classList.remove("hidden"))}hideSetupError(){let e=document.getElementById("kms-setup-error");e&&e.classList.add("hidden")}showSetupLoading(){let e=document.getElementById("kms-setup-loading");e&&e.classList.remove("hidden")}hideSetupLoading(){let e=document.getElementById("kms-setup-loading");e&&e.classList.add("hidden")}showSetupSuccess(){let e=document.getElementById("kms-setup-success");e&&e.classList.remove("hidden")}hideSetupSuccess(){let e=document.getElementById("kms-setup-success");e&&e.classList.add("hidden")}notifySetupComplete(e){let t={type:"kms:setup-complete",method:e.method,result:e.result};window.opener&&window.opener.postMessage(t,this.parentOrigin);try{localStorage.setItem("kms:setup-complete",JSON.stringify({timestamp:Date.now(),...t}))}catch(r){console.warn("[KMS Client] Failed to set localStorage flag:",r)}try{let r=new BroadcastChannel("kms-setup");r.postMessage(t),r.close()}catch(r){console.warn("[KMS Client] BroadcastChannel not available:",r)}}async terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.isInitialized=!1}async send(e){let{handleMessage:t}=await Promise.resolve().then(()=>(Ht(),Ft));return await t(e)}};if(typeof window<"u"&&typeof document<"u"){let s=new URLSearchParams(window.location.search),e=s.get("parentOrigin")??"https://allthe.services",t=window.self!==window.top,r=s.get("mode")==="setup"||s.has("setup"),n=!t&&(window.opener!==null||r),a=new Ve({parentOrigin:e}),o=()=>{if(a.init().catch(d=>{console.error("[KMS Client] Auto-initialization failed:",d)}),n)if(s.has("transportKey")&&s.has("keyId"))setTimeout(()=>{a.setupSetupModalHandlers();let i=document.getElementById("setup-modal");i&&i.classList.remove("hidden")},100);else{console.log("[KMS Client] Popup in KMS-only mode, signaling ready to parent...");let i=s.get("parentOrigin")??"http://localhost:5173";window.opener&&window.opener.postMessage({type:"kms:popup-ready"},i),window.addEventListener("message",u=>{if(u.data?.type==="kms:connect-port"&&u.origin===i){if(console.log("[KMS Client] Popup received kms:connect-port from parent"),!u.ports||!u.ports[0]){console.error("[KMS Client] No MessagePort received with kms:connect-port");return}let c=u.ports[0];c.onmessage=p=>{let y=p.data;y?.type==="kms:connect"&&(console.log("[KMS Client] Popup received kms:connect via MessagePort"),a.transportPublicKey=y.transportKey,a.transportKeyId=y.transportKeyId,a.appSalt=y.appSalt,a.hkdfSalt=y.hkdfSalt,a.isStatelessPopup=!0,a.credentialPort=c,c.postMessage({type:"popup:connected"}),setTimeout(()=>{a.setupSetupModalHandlers();let f=document.getElementById("setup-modal");f&&f.classList.remove("hidden")},100))}}})}};if(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",o):o(),document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{let d=document.getElementById("kms-unlock-form"),i=document.getElementById("kms-setup-form");d&&d.addEventListener("submit",u=>(u.preventDefault(),!1)),i&&i.addEventListener("submit",u=>(u.preventDefault(),!1))});else{let d=document.getElementById("kms-unlock-form"),i=document.getElementById("kms-setup-form");d&&d.addEventListener("submit",u=>(u.preventDefault(),!1)),i&&i.addEventListener("submit",u=>(u.preventDefault(),!1))}if(t){try{new BroadcastChannel("kms-setup-credentials").addEventListener("message",u=>{console.log("[KMS Client] Iframe received credentials from popup via BroadcastChannel"),u.data?.type==="kms:setup-credentials"&&window.parent&&(window.parent.postMessage(u.data,e),console.log("[KMS Client] Iframe forwarded credentials to parent"))}),new BroadcastChannel("kms-setup").addEventListener("message",u=>{let l=u.data;l?.type==="kms:setup-complete"&&window.parent&&window.parent.postMessage(l,e)})}catch(d){console.warn("[KMS Client] BroadcastChannel not available for iframe:",d)}window.addEventListener("storage",d=>{if(d.key==="kms:setup-credentials"&&d.newValue)try{console.log("[KMS Client] Iframe received credentials from popup via localStorage");let i=JSON.parse(d.newValue);i?.type==="kms:setup-credentials"&&(window.parent&&(window.parent.postMessage(i,e),console.log("[KMS Client] Iframe forwarded credentials to parent")),localStorage.removeItem("kms:setup-credentials"))}catch(i){console.warn("[KMS Client] Failed to parse setup-credentials from localStorage:",i)}if(d.key==="kms:setup-complete"&&d.newValue)try{let i=JSON.parse(d.newValue);window.parent&&window.parent.postMessage({type:i.type,method:i.method,result:i.result},e),localStorage.removeItem("kms:setup-complete")}catch(i){console.warn("[KMS Client] Failed to parse setup-complete from localStorage:",i)}});try{let d=localStorage.getItem("kms:setup-complete");if(d){let i=JSON.parse(d);i.timestamp&&Date.now()-i.timestamp<5e3&&window.parent&&window.parent.postMessage({type:i.type,method:i.method,result:i.result},e),localStorage.removeItem("kms:setup-complete")}}catch(d){console.warn("[KMS Client] Failed to check localStorage for setup-complete:",d)}}window.__kmsClient=a,window.__kmsContext={isIframe:t,isStandaloneSetup:n}}export{Ve as KMSClient};
