<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AllTheServices KMS Enclave</title>
  <meta name="description" content="AllTheServices Key Management System Enclave">
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="enclave.css">
</head>
<body>
  <!-- Iframe Status Display (shown when embedded in iframe) -->
  <div class="enclave-status">
    <div class="header">
      <img src="logo.png" alt="AllTheServices" class="logo">
      <h1>AllTheServices KMS Enclave</h1>
    </div>
    <p><span class="status">Active</span> - Worker loaded and ready</p>
    <div>
      <strong>Worker Hash:</strong>
      <div class="hash">1c0afa3e7055c34bbdc7a822479068783b33a773cedcf4439b62584df3876c7c</div>
    </div>
    <p class="description">
      This iframe runs in a sandboxed cross-origin context.
      All cryptographic operations are isolated from the parent PWA.
    </p>
  </div>

  <!-- Unlock Modal (shown in popup window for unlock) -->
  <div id="unlock-modal" class="kms-modal hidden">
    <div class="kms-modal-backdrop"></div>
    <div class="kms-modal-content">
      <div class="kms-modal-header">
        <h3>🔐 Unlock KMS</h3>
        <p class="kms-modal-subtitle">Choose your unlock method</p>
      </div>

      <div class="kms-modal-body">
        <!-- WebAuthn Option -->
        <div class="kms-auth-option">
          <button id="kms-webauthn-btn" class="kms-auth-btn kms-primary">
            <span class="kms-auth-icon">🔑</span>
            <span class="kms-auth-label">Use Passkey</span>
          </button>
          <p class="kms-auth-hint">Authenticate with your device biometrics</p>
        </div>

        <!-- Divider -->
        <div class="kms-divider">
          <span>or</span>
        </div>

        <!-- Passphrase Option -->
        <div class="kms-auth-option">
          <form id="kms-unlock-form">
            <input type="text" name="username" autocomplete="username" class="kms-hidden-username" value="kms-user" readonly />
            <label for="kms-passphrase-input" class="kms-input-label">Passphrase</label>
            <input
              type="password"
              id="kms-passphrase-input"
              name="password"
              class="kms-input"
              placeholder="Enter your passphrase"
              autocomplete="current-password"
            />
            <button id="kms-passphrase-btn" type="button" class="kms-auth-btn kms-secondary">
              <span class="kms-auth-icon">🔐</span>
              <span class="kms-auth-label">Unlock with Passphrase</span>
            </button>
          </form>
        </div>

        <!-- Error Display -->
        <div id="kms-modal-error" class="kms-modal-error hidden"></div>

        <!-- Loading State -->
        <div id="kms-modal-loading" class="kms-modal-loading hidden">
          <span class="kms-spinner"></span>
          <span>Unlocking...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Setup Modal (shown in popup window for setup) -->
  <div id="setup-modal" class="kms-modal hidden">
    <div class="kms-modal-backdrop"></div>
    <div class="kms-modal-content">
      <div class="kms-modal-header">
        <h3>🔐 Setup KMS Authentication</h3>
        <p class="kms-modal-subtitle">Choose your authentication method</p>
      </div>

      <div class="kms-modal-body">
        <!-- WebAuthn Setup Option -->
        <div class="kms-auth-option">
          <button id="kms-setup-webauthn-btn" class="kms-auth-btn kms-primary">
            <span class="kms-auth-icon">🔑</span>
            <span class="kms-auth-label">Setup Passkey</span>
          </button>
          <p class="kms-auth-hint">Register your device biometrics</p>
        </div>

        <!-- Divider -->
        <div class="kms-divider">
          <span>or</span>
        </div>

        <!-- Passphrase Setup Option -->
        <div class="kms-auth-option">
          <form id="kms-setup-form">
            <input type="text" name="username" autocomplete="username" class="kms-hidden-username" value="kms-user" readonly />
            <label for="kms-setup-passphrase-input" class="kms-input-label">Create Passphrase</label>
            <input
              type="password"
              id="kms-setup-passphrase-input"
              name="new-password"
              class="kms-input"
              placeholder="Enter a strong passphrase (min 12 chars)"
              autocomplete="new-password"
            />
            <div id="kms-passphrase-char-count" class="kms-char-count">
              0 / 12 characters
            </div>
            <label for="kms-setup-passphrase-confirm-input" class="kms-input-label">Confirm Passphrase</label>
            <input
              type="password"
              id="kms-setup-passphrase-confirm-input"
              name="new-password"
              class="kms-input"
              placeholder="Re-enter your passphrase"
              autocomplete="new-password"
            />
            <div id="kms-passphrase-match-feedback" class="kms-match-feedback hidden">
              <!-- Feedback will be inserted here dynamically -->
            </div>
            <button id="kms-setup-passphrase-btn" type="button" class="kms-auth-btn kms-secondary">
              <span class="kms-auth-icon">🔐</span>
              <span class="kms-auth-label">Setup with Passphrase</span>
            </button>
          </form>
        </div>

        <!-- Error Display -->
        <div id="kms-setup-error" class="kms-modal-error hidden"></div>

        <!-- Loading State -->
        <div id="kms-setup-loading" class="kms-modal-loading hidden">
          <span class="kms-spinner"></span>
          <span>Setting up...</span>
        </div>

        <!-- Success State -->
        <div id="kms-setup-success" class="kms-setup-success hidden">
          <div class="kms-success-content">
            <span class="kms-success-icon">✅</span>
            <div>
              <div class="kms-success-title">Setup Complete!</div>
              <div class="kms-success-message">You can now close this window and return to the main app.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="enclave-client.js"></script>
</body>
</html>